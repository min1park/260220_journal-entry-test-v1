<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IFRS 16 ë¦¬ìŠ¤ ê³„ì‚°ê¸° v5.0 ê²°ì‚°ë³´ê³ ì„œ</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  body { margin: 0; background: #0f172a; }
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useMemo } = React;

// ================================================================
// IFRS 16 ë¦¬ìŠ¤ ê³„ì‚°ê¸° v5.0 (ê²°ì‚° ë³´ê³ ì„œ ê¸°ëŠ¥ ì¶”ê°€)
// ================================================================

const CAT_PREFIX = { 'ë¶€ë™ì‚°': 'R', 'ì°¨ëŸ‰ìš´ë°˜êµ¬': 'V', 'ê¸°ê³„ì¥ì¹˜': 'M', 'ë¹„í’ˆ': 'F' };
const FREQ_OPTIONS = [
  { v: 1, l: 'ë§¤ì›” (1ê°œì›”)' },
  { v: 2, l: 'ê²©ì›” (2ê°œì›”)' },
  { v: 3, l: 'ë¶„ê¸° (3ê°œì›”)' },
  { v: 6, l: 'ë°˜ê¸° (6ê°œì›”)' },
  { v: 12, l: 'ì—° (12ê°œì›”)' }
];

const fmt = (n) => Math.round(n).toLocaleString();
const toISO = (d) => {
  const o = d.getTimezoneOffset() * 60000;
  return new Date(d.getTime() - o).toISOString().split('T')[0];
};
const parseDate = (v) => {
  if (!v) return '';
  if (typeof v === 'number') return new Date((v - 25569) * 86400000).toISOString().split('T')[0];
  return String(v).split('T')[0];
};

const genLeaseId = (category, allLeases) => {
  const prefix = CAT_PREFIX[category] || 'X';
  const year = new Date().getFullYear();
  const nums = allLeases
    .filter(l => l.lease_id && l.lease_id.startsWith(`${prefix}-${year}-`))
    .map(l => parseInt(l.lease_id.split('-')[2]) || 0);
  const next = nums.length > 0 ? Math.max(...nums) + 1 : 1;
  return `${prefix}-${year}-${String(next).padStart(3, '0')}`;
};

// ================================================================
// ê³„ì‚° ì—”ì§„
// ================================================================
const calcMonthsByDate = (s, e) => {
  if (!s || !e) return 0;
  const sd = new Date(s), ed = new Date(e);
  return Math.max(0, (ed.getFullYear()-sd.getFullYear())*12 + (ed.getMonth()-sd.getMonth()) + 1);
};

const getPayDates = (startDate, totalMonths, timing, freq = 1) => {
  const items = [];
  const s = new Date(startDate);
  s.setDate(1); 
  s.setHours(12,0,0,0); 

  for (let i = 0; i < totalMonths; i += freq) {
    const monthsInPeriod = Math.min(freq, totalMonths - i);
    let d;
    
    if (timing === 'prepaid') {
      d = new Date(s.getFullYear(), s.getMonth() + i, 1);
    } else {
      d = new Date(s.getFullYear(), s.getMonth() + i + monthsInPeriod, 0);
    }
    
    d.setHours(12,0,0,0);
    items.push({ date: d, monthsCovered: monthsInPeriod });
  }
  return items;
};

const calcAnnuityPV = (rate, n, pmt, residual, timing, months, freq) => {
  if (rate === 0) return (pmt * n) + residual;

  const periodRate = Math.pow(1 + rate, freq) - 1;

  let annuityFactor = 0;
  if (timing === 'prepaid') {
    if (n === 1) annuityFactor = 1;
    else annuityFactor = 1 + (1 - Math.pow(1 + periodRate, -(n - 1))) / periodRate;
  } else {
    annuityFactor = (1 - Math.pow(1 + periodRate, -n)) / periodRate;
  }
  const pmtPV = pmt * annuityFactor;

  const resPV = residual > 0 ? residual * Math.pow(1 + rate, -months) : 0;

  return pmtPV + resPV;
};

const computeLease = (lease) => {
  try {
    const userMonths = parseInt(lease.leaseTerm);
    const dateMonths = calcMonthsByDate(lease.startDate, lease.endDate);
    const months = (userMonths > 0) ? userMonths : dateMonths;

    if (months === 0) return { 
      error: 'ë¦¬ìŠ¤ ê¸°ê°„ì´ 0ê°œì›”ì…ë‹ˆë‹¤.',
      months:0, schedule:[], cashFlows:[], subleaseSchedule:[]
    };

    const freq = parseInt(lease.paymentFrequency || 1);
    const annRate = (parseFloat(lease.ibrRate)||0)/100;
    
    if (annRate < 0) {
      return { error: 'ì´ììœ¨ì€ 0% ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', months, schedule:[], cashFlows:[], subleaseSchedule:[] };
    }
    
    const monRate = annRate > 0 ? Math.pow(1 + annRate, 1/12) - 1 : 0;
    
    const pmt = parseFloat(lease.monthlyPayment)||0;
    const prepaid = parseFloat(lease.prepaidLease)||0;
    const directCost = parseFloat(lease.initialDirectCost)||0;
    const incentive = parseFloat(lease.leaseIncentive)||0;
    const residual = parseFloat(lease.residualValue)||0;

    if (pmt <= 0) {
      return { error: 'ë¦¬ìŠ¤ë£ŒëŠ” 0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.', months, schedule:[], cashFlows:[], subleaseSchedule:[] };
    }

    const payItems = getPayDates(lease.startDate, months, lease.paymentTiming, freq);
    
    const startDateObj = new Date(lease.startDate);
    startDateObj.setDate(1); startDateObj.setHours(12,0,0,0); 

    const cashFlows = [];
    cashFlows.push({ seq: 0, date: toISO(startDateObj), amount: 0, description: 'ê¸°ì¤€ì¼' });

    payItems.forEach((item, idx) => {
      cashFlows.push({
        seq: idx + 1,
        date: item.date.toISOString().split('T')[0],
        amount: pmt,
        description: `${idx+1}íšŒì°¨`
      });
    });

    if (residual > 0) {
      const endDate = new Date(lease.endDate);
      endDate.setHours(12,0,0,0);
      cashFlows.push({ 
        seq: 'ì”ì¡´', 
        date: toISO(endDate), 
        amount: residual,
        description: 'ì”ì¡´ê°€ì¹˜ë³´ì¦'
      });
    }

    const numPayments = payItems.length;
    const pvLeasePayments = calcAnnuityPV(monRate, numPayments, pmt, residual, lease.paymentTiming, months, freq);

    const isModification = lease.isModification;
    let carryLiab = 0, carryROU = 0, carryCost = 0, carryAccumDepr = 0;
    
    if (isModification) {
      carryLiab = parseFloat(lease.carriedOverLiability)||0;
      carryROU = parseFloat(lease.carriedOverROU)||0;
      carryCost = parseFloat(lease.carriedOverAssetCost)||0;
      carryAccumDepr = parseFloat(lease.carriedOverAccumDepreciation)||0;
      
      if (carryLiab === 0 || carryROU === 0) {
        return { error: 'ë³€ê²½ ê³„ì•½ì€ ì´ì›” ë¶€ì±„ ë° ìì‚° ì…ë ¥ í•„ìˆ˜ì…ë‹ˆë‹¤.', months, schedule:[], cashFlows:[], subleaseSchedule:[] };
      }
    }

    const initialLiability = isModification ? carryLiab : pvLeasePayments;
    const assetCost = isModification 
      ? carryCost 
      : pvLeasePayments + prepaid + directCost - incentive;
    const initialROU = isModification ? carryROU : assetCost;

    let effectiveMonths = months;
    let subleaseStartPeriod = null;
    let isFinanceSublease = false;

    if (lease.isSublease && lease.subleaseType === 'finance' && lease.subleaseStartDate) {
      const subStart = new Date(lease.subleaseStartDate);
      const leaseStart = new Date(lease.startDate);
      const subMonth = Math.max(0, (subStart.getFullYear()-leaseStart.getFullYear())*12 + (subStart.getMonth()-leaseStart.getMonth()));
      
      if (subMonth < months) {
        isFinanceSublease = true;
        effectiveMonths = subMonth;
        subleaseStartPeriod = subMonth + 1;
      }
    }

    const monthlyDepreciation = effectiveMonths > 0 ? assetCost / effectiveMonths : 0;

    const schedule = [];
    let liab = initialLiability;
    let nbv = initialROU;
    let accumDepreciation = isModification ? carryAccumDepr : 0;

    for (let m = 0; m < months; m++) {
      const paymentIdx = Math.floor(m / freq);
      let isPaidThisMonth = (m % freq === 0) && paymentIdx < numPayments;
      if (lease.paymentTiming === 'postpaid' && m % freq === (freq - 1) && paymentIdx < numPayments) {
        isPaidThisMonth = true;
      }
      
      const paymentDate = isPaidThisMonth 
        ? payItems[paymentIdx].date.toISOString().split('T')[0] 
        : '';

      const isSubleasePeriod = isFinanceSublease && m >= subleaseStartPeriod - 1;

      const beginLiability = liab;
      const interest = liab * monRate;
      const payment = isPaidThisMonth ? pmt : 0;
      const principal = payment - interest;
      const endLiability = Math.max(0, liab - principal);

      let currentDepreciation = 0;
      if (!isSubleasePeriod) {
        currentDepreciation = monthlyDepreciation;
        accumDepreciation += currentDepreciation;
        nbv = Math.max(0, nbv - currentDepreciation);
      }

      schedule.push({
        period: m + 1,
        paymentDate: paymentDate || '',
        beginLiability: beginLiability,
        interest: interest,
        payment: payment,
        principal: principal,
        endLiability: endLiability,
        monthlyDepreciation: currentDepreciation,
        netBookValue: nbv,
        accumulatedDepreciation: accumDepreciation,
        isSubleasePeriod: isSubleasePeriod
      });

      liab = endLiability;
    }

    let subleaseSchedule = [];
    let subleaseReceivable = 0;

    if (isFinanceSublease && subleaseStartPeriod) {
      const remainingLiability = schedule[subleaseStartPeriod - 2]?.endLiability || 0;
      const remainingNBV = schedule[subleaseStartPeriod - 2]?.netBookValue || 0;

      subleaseReceivable = remainingLiability;
      const subMonths = months - (subleaseStartPeriod - 1);

      if (subMonths > 0) {
        let receivable = subleaseReceivable;
        const subCollectionPerMonth = pmt;

        for (let s = 0; s < subMonths; s++) {
          const paymentIdx = Math.floor((subleaseStartPeriod - 1 + s) / freq);
          let isCollected = ((subleaseStartPeriod - 1 + s) % freq === 0) && paymentIdx < numPayments;
          if (lease.paymentTiming === 'postpaid' && (subleaseStartPeriod - 1 + s) % freq === (freq - 1) && paymentIdx < numPayments) {
            isCollected = true;
          }

          const beginReceivable = receivable;
          const interestIncome = receivable * monRate;
          const collection = isCollected ? subCollectionPerMonth : 0;
          const principalCollection = collection - interestIncome;
          const endReceivable = Math.max(0, receivable - principalCollection);

          subleaseSchedule.push({
            seq: s + 1,
            date: isCollected ? payItems[paymentIdx].date.toISOString().split('T')[0] : '',
            beginReceivable: beginReceivable,
            interestIncome: interestIncome,
            collection: collection,
            principalCollection: principalCollection,
            endReceivable: endReceivable
          });

          receivable = endReceivable;
        }
      }
    }

    return {
      months,
      initialLiability,
      initialROU,
      assetCost,
      monthlyDepreciation,
      schedule,
      cashFlows,
      isFinanceSublease,
      subleaseSchedule,
      subleaseReceivable
    };

  } catch (err) {
    return { error: `ê³„ì‚° ì˜¤ë¥˜: ${err.message}`, months:0, schedule:[], cashFlows:[], subleaseSchedule:[] };
  }
};

// ================================================================
// ğŸ†• ê²°ì‚° ë³´ê³ ì„œ ì§‘ê³„ í•¨ìˆ˜
// ================================================================
const generateAnnualReport = (leases, fiscalYear) => {
  const fy = parseInt(fiscalYear);
  const beginDate = `${fy-1}-12-31`;
  const endDate = `${fy}-12-31`;
  
  // í™œì„± ë¦¬ìŠ¤ë§Œ í•„í„°ë§
  const activeLeases = leases.filter(l => l.status === 'active' && l.calculatedData && !l.calculatedData.error);
  
  // ìì‚°êµ°ë³„ ê·¸ë£¹í™”
  const categories = ['ë¶€ë™ì‚°', 'ì°¨ëŸ‰ìš´ë°˜êµ¬', 'ê¸°ê³„ì¥ì¹˜', 'ë¹„í’ˆ'];
  const report = {};
  
  categories.forEach(cat => {
    const catLeases = activeLeases.filter(l => l.assetCategory === cat);
    if (catLeases.length === 0) return;
    
    // ì‹ ê·œ/ê¸°ì¡´ ë¶„ë¥˜
    const newLeases = catLeases.filter(l => {
      const startYear = new Date(l.startDate).getFullYear();
      return startYear === fy;
    });
    const existingLeases = catLeases.filter(l => {
      const startYear = new Date(l.startDate).getFullYear();
      return startYear < fy;
    });
    
    // ë¦¬ìŠ¤ë¶€ì±„ ì§‘ê³„
    const liabBegin = sumBalanceAtDate(existingLeases, beginDate, 'liability');
    const liabEnd = sumBalanceAtDate(catLeases, endDate, 'liability');
    const liabNew = sumInitialBalances(newLeases, fy, 'liability');
    const liabInterest = sumPeriodItems(catLeases, fy, 'interest');
    const liabPrincipal = sumPeriodItems(catLeases, fy, 'principal');
    const liabIncrease = liabNew;
    const liabDecrease = liabPrincipal;
    
    // ì‚¬ìš©ê¶Œìì‚° ì§‘ê³„
    const rouBegin = sumBalanceAtDate(existingLeases, beginDate, 'rou');
    const rouEnd = sumBalanceAtDate(catLeases, endDate, 'rou');
    const rouNew = sumInitialBalances(newLeases, fy, 'rou');
    const rouDepreciation = sumPeriodItems(catLeases, fy, 'depreciation');
    const rouIncrease = rouNew;
    const rouDecrease = 0; // ì¢…ë£Œë¡œ ì¸í•œ ê°ì†ŒëŠ” ë³„ë„ ì¶”ì  í•„ìš”
    
    report[cat] = {
      newLeases: newLeases.length,
      existingLeases: existingLeases.length,
      liability: {
        begin: liabBegin,
        increase: liabIncrease,
        interest: liabInterest,
        decrease: liabDecrease,
        end: liabEnd
      },
      rou: {
        begin: rouBegin,
        increase: rouIncrease,
        depreciation: rouDepreciation,
        decrease: rouDecrease,
        end: rouEnd
      }
    };
  });
  
  return report;
};

// íŠ¹ì • ì‹œì ì˜ ì”ì•¡ í•©ê³„ (ê¸°ë§ ê¸°ì¤€)
const sumBalanceAtDate = (leases, dateStr, type) => {
  let total = 0;
  const targetDate = new Date(dateStr);
  
  leases.forEach(lease => {
    const calc = lease.calculatedData;
    if (!calc || !calc.schedule) return;
    
    const startDate = new Date(lease.startDate);
    const endDate = new Date(lease.endDate);
    
    if (targetDate < startDate || targetDate > endDate) return;
    
    // í•´ë‹¹ ì›”ê¹Œì§€ì˜ ìŠ¤ì¼€ì¤„ ì°¾ê¸°
    const monthsElapsed = Math.floor((targetDate - startDate) / (1000*60*60*24*30));
    const scheduleRow = calc.schedule[Math.min(monthsElapsed, calc.schedule.length - 1)];
    
    if (scheduleRow) {
      if (type === 'liability') {
        total += scheduleRow.endLiability;
      } else if (type === 'rou') {
        total += scheduleRow.netBookValue;
      }
    }
  });
  
  return total;
};

// ì‹ ê·œ ë¦¬ìŠ¤ì˜ ì´ˆê¸° ì”ì•¡ í•©ê³„
const sumInitialBalances = (leases, fiscalYear, type) => {
  let total = 0;
  leases.forEach(lease => {
    const calc = lease.calculatedData;
    if (!calc) return;
    
    const startYear = new Date(lease.startDate).getFullYear();
    if (startYear === fiscalYear) {
      if (type === 'liability') {
        total += calc.initialLiability || 0;
      } else if (type === 'rou') {
        total += calc.initialROU || 0;
      }
    }
  });
  return total;
};

// ê¸°ê°„ ì¤‘ ë°œìƒì•¡ í•©ê³„ (ì´ìë¹„ìš©, ì›ê¸ˆìƒí™˜, ê°ê°€ìƒê°)
const sumPeriodItems = (leases, fiscalYear, type) => {
  let total = 0;
  const fyStart = new Date(`${fiscalYear}-01-01`);
  const fyEnd = new Date(`${fiscalYear}-12-31`);
  
  leases.forEach(lease => {
    const calc = lease.calculatedData;
    if (!calc || !calc.schedule) return;
    
    calc.schedule.forEach(row => {
      const rowDate = new Date(lease.startDate);
      rowDate.setMonth(rowDate.getMonth() + row.period - 1);
      
      if (rowDate >= fyStart && rowDate <= fyEnd) {
        if (type === 'interest') {
          total += row.interest || 0;
        } else if (type === 'principal') {
          total += row.principal || 0;
        } else if (type === 'depreciation') {
          total += row.monthlyDepreciation || 0;
        }
      }
    });
  });
  
  return total;
};

// ================================================================
// React App
// ================================================================
const App = () => {
  const [leases, setLeases] = useState([]);
  const [activeTab, setActiveTab] = useState('input');
  const [form, setForm] = useState({
    assetCategory: 'ë¶€ë™ì‚°',
    leaseName: '',
    department: '',
    assetDetail: '',
    startDate: '',
    endDate: '',
    leaseTerm: '',
    monthlyPayment: '',
    paymentFrequency: 1,
    paymentTiming: 'prepaid',
    ibrRate: '',
    prepaidLease: '0',
    initialDirectCost: '0',
    leaseIncentive: '0',
    residualValue: '0',
    isSublease: false,
    subleaseType: 'finance',
    subleaseStartDate: '',
    notes: '',
    carriedOverLiability: '',
    carriedOverROU: '',
    carriedOverAssetCost: '',
    carriedOverAccumDepreciation: ''
  });

  const [modMode, toggleModMode] = useState(false);
  const [selParent, setSelParent] = useState(null);
  const [selectedLease, setSelectedLease] = useState(null);
  const [cmpId, setCmpId] = useState(null);
  const [showCashFlows, setShowCashFlows] = useState(false);
  
  // ğŸ†• ê²°ì‚° ë³´ê³ ì„œ ìƒíƒœ
  const [fiscalYear, setFiscalYear] = useState(new Date().getFullYear());

  useEffect(() => {
    const saved = localStorage.getItem('leaseData_v4');
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        const computed = parsed.map(l => ({...l, calculatedData: computeLease(l)}));
        setLeases(computed);
      } catch(e) {
        console.error('ë¡œë”© ì‹¤íŒ¨:', e);
      }
    }
  }, []);

  useEffect(() => {
    if (leases.length > 0) {
      localStorage.setItem('leaseData_v4', JSON.stringify(leases));
    }
  }, [leases]);

  const activeLeases = useMemo(() => leases.filter(l => l.status === 'active'), [leases]);
  const leaseGroups = useMemo(() => {
    const groups = {};
    leases.forEach(l => {
      if (!groups[l.lease_id]) groups[l.lease_id] = [];
      groups[l.lease_id].push(l);
    });
    Object.values(groups).forEach(g => g.sort((a,b) => a.version - b.version));
    return groups;
  }, [leases]);

  const totalLiab = useMemo(() => 
    activeLeases.reduce((sum, l) => 
      sum + (l.calculatedData?.initialLiability || 0), 0
    ), [activeLeases]
  );

  const selectParent = (l) => {
    setSelParent(l);
    const newStartDate = form.startDate || toISO(new Date());
    setForm({
      ...form,
      assetCategory: l.assetCategory,
      leaseName: l.leaseName,
      department: l.department,
      assetDetail: l.assetDetail,
      startDate: newStartDate,
      endDate: '',
      leaseTerm: '',
      monthlyPayment: l.monthlyPayment,
      paymentFrequency: l.paymentFrequency,
      paymentTiming: l.paymentTiming,
      ibrRate: l.ibrRate,
      prepaidLease: '0',
      initialDirectCost: '0',
      leaseIncentive: '0',
      residualValue: '0',
      isSublease: false,
      subleaseType: 'finance',
      subleaseStartDate: '',
      notes: '',
      carriedOverLiability: '',
      carriedOverROU: '',
      carriedOverAssetCost: '',
      carriedOverAccumDepreciation: ''
    });
  };

  const fetchBalanceAtDate = () => {
    if (!selParent || !form.startDate) {
      alert('ë³€ê²½ì¼(ì‹œì‘ì¼)ì„ ì…ë ¥í•˜ì„¸ìš”.');
      return;
    }

    const modDate = new Date(form.startDate);
    modDate.setDate(modDate.getDate() - 1);
    const targetDate = toISO(modDate);

    const calc = selParent.calculatedData;
    if (!calc || !calc.schedule || calc.schedule.length === 0) {
      alert('ë¶€ëª¨ ë¦¬ìŠ¤ ê³„ì‚° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    const startDate = new Date(selParent.startDate);
    const monthsElapsed = Math.max(0, Math.floor((modDate - startDate) / (1000*60*60*24*30)));
    const row = calc.schedule[Math.min(monthsElapsed, calc.schedule.length - 1)];

    if (!row) {
      alert('í•´ë‹¹ ì‹œì ì˜ ì”ì•¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    setForm({
      ...form,
      carriedOverLiability: String(Math.round(row.endLiability)),
      carriedOverROU: String(Math.round(row.netBookValue)),
      carriedOverAssetCost: String(Math.round(calc.assetCost || 0)),
      carriedOverAccumDepreciation: String(Math.round(row.accumulatedDepreciation || 0))
    });

    alert(`âœ… ${targetDate} ì‹œì  ì”ì•¡ ì¡°íšŒ ì™„ë£Œ`);
  };

  const handleSubmit = () => {
    if (!form.leaseName || !form.startDate) {
      alert('ë¦¬ìŠ¤ëª…ê³¼ ì‹œì‘ì¼ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.');
      return;
    }

    const isModification = modMode && selParent;
    const newLeaseId = isModification ? selParent.lease_id : genLeaseId(form.assetCategory, leases);
    const newVersion = isModification 
      ? Math.max(...leases.filter(l => l.lease_id === selParent.lease_id).map(l => l.version)) + 1 
      : 1;

    if (isModification) {
      setLeases(prev => prev.map(l => 
        l.lease_id === selParent.lease_id && l.version === selParent.version
          ? {...l, status: 'superseded'}
          : l
      ));
    }

    const newLease = {
      lease_id: newLeaseId,
      version: newVersion,
      status: 'active',
      ...form,
      isModification: isModification,
      parentLeaseId: isModification ? selParent.lease_id : '',
      parentVersion: isModification ? selParent.version : 0,
      calculatedData: null
    };

    newLease.calculatedData = computeLease(newLease);

    if (newLease.calculatedData.error) {
      alert(`âš ï¸ ê³„ì‚° ì˜¤ë¥˜: ${newLease.calculatedData.error}`);
      return;
    }

    setLeases(prev => [...prev, newLease]);
    
    setForm({
      assetCategory: 'ë¶€ë™ì‚°',
      leaseName: '',
      department: '',
      assetDetail: '',
      startDate: '',
      endDate: '',
      leaseTerm: '',
      monthlyPayment: '',
      paymentFrequency: 1,
      paymentTiming: 'prepaid',
      ibrRate: '',
      prepaidLease: '0',
      initialDirectCost: '0',
      leaseIncentive: '0',
      residualValue: '0',
      isSublease: false,
      subleaseType: 'finance',
      subleaseStartDate: '',
      notes: '',
      carriedOverLiability: '',
      carriedOverROU: '',
      carriedOverAssetCost: '',
      carriedOverAccumDepreciation: ''
    });

    if (modMode) {
      toggleModMode(false);
      setSelParent(null);
    }

    alert('âœ… ë“±ë¡ ì™„ë£Œ!');
  };

  const deleteLease = (id, ver) => {
    if (!window.confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    setLeases(prev => prev.filter(l => !(l.lease_id === id && l.version === ver)));
  };

  const setStartPreset = (mode) => {
    const now = new Date();
    if (mode === 'y') setForm({...form, startDate: `${now.getFullYear()}-01-01`});
    else if (mode === 'm') setForm({...form, startDate: `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-01`});
  };

  const calcDiff = (leaseId) => {
    const versions = leaseGroups[leaseId] || [];
    if (versions.length < 2) return [];

    const diffs = [];
    for (let i = 1; i < versions.length; i++) {
      const v1 = versions[i-1];
      const v2 = versions[i];
      const c1 = v1.calculatedData;
      const c2 = v2.calculatedData;

      if (!c1 || !c2 || c1.error || c2.error) continue;

      const liabBefore = parseFloat(v2.carriedOverLiability || 0);
      const liabAfter = c2.initialLiability;
      const rouBefore = parseFloat(v2.carriedOverROU || 0);
      const rouAfter = c2.initialROU;

      diffs.push({
        v1, v2,
        modDate: v2.startDate,
        liabBefore,
        liabAfter,
        liabDiff: liabAfter - liabBefore,
        rouBefore,
        rouAfter,
        rouDiff: rouAfter - rouBefore
      });
    }
    return diffs;
  };

  const clearAllData = () => {
    if (!window.confirm('âš ï¸ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    setLeases([]);
    localStorage.removeItem('leaseData_v4');
    alert('âœ… ì „ì²´ ì´ˆê¸°í™” ì™„ë£Œ');
  };

  const downloadTemplate = () => {
    const header = [
      'ë¦¬ìŠ¤ID','ë²„ì „','êµ¬ë¶„','ë¦¬ìŠ¤ëª…','ì œì¶œë¶€ì„œ','ìì‚°ì„¸ë¶€ë‚´ì—­',
      'ë¦¬ìŠ¤ì‹œì‘ì¼','ë¦¬ìŠ¤ì¢…ë£Œì¼','ê³„ì•½ì›”ìˆ˜','íšŒì°¨ë³„ë¦¬ìŠ¤ë£Œ','ë‚©ë¶€ì£¼ê¸°ì›”ìˆ˜','ë‚©ë¶€ë°©ì‹',
      'ì¦ë¶„ì°¨ì…ì´ììœ¨(%)','ì„ ê¸‰ë¦¬ìŠ¤ë£Œ','ì´ˆê¸°ì§ì ‘ì›ê°€','ë¦¬ìŠ¤ì¸ì„¼í‹°ë¸Œ','ì”ì¡´ê°€ì¹˜ë³´ì¦',
      'ë³€ê²½ê³„ì•½(Y/N)','ë¶€ëª¨ë¦¬ìŠ¤ID','ë¶€ëª¨ë²„ì „','ì´ì›”ë¶€ì±„','ì´ì›”ìì‚°','ì´ì›”ì·¨ë“ê°€ì•¡','ì´ì›”ê°ê°€ìƒê°ëˆ„ê³„ì•¡',
      'ì „ëŒ€ë¦¬ìŠ¤ì—¬ë¶€(Y/N)','ì „ëŒ€ìœ í˜•(finance/operating)','ì „ëŒ€ì‹œì‘ì¼','ë¹„ê³ '
    ];

    const rows = [
      ['ìë™ìƒì„±',1,'ë¶€ë™ì‚°','ë³¸ì‚¬ ë¹Œë”©','ì¬ë¬´íŒ€','ì„œìš¸ ê°•ë‚¨êµ¬','2024-01-01','2026-12-31',36,5000000,1,'ì„ ê¸‰',3.5,0,100000,0,0,'N','','',0,0,0,0,'N','','','']
    ];

    const ws = XLSX.utils.aoa_to_sheet([header, ...rows]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'ë¦¬ìŠ¤ ì…ë ¥ í…œí”Œë¦¿');
    XLSX.writeFile(wb, 'IFRS16_ë¦¬ìŠ¤ì…ë ¥_í…œí”Œë¦¿.xlsx');
  };

  const exportBackup = () => {
    try {
      const masterData = leases.map(l => ({
        'ë¦¬ìŠ¤ID': l.lease_id, 'ë²„ì „': l.version, 'ìƒíƒœ': l.status === 'active' ? 'í™œì„±' : 'ëŒ€ì²´ë¨',
        'êµ¬ë¶„': l.assetCategory, 'ë¦¬ìŠ¤ëª…': l.leaseName, 'ë¶€ì„œ': l.department, 'ìì‚°ì„¸ë¶€ë‚´ì—­': l.assetDetail,
        'ì‹œì‘ì¼': l.startDate, 'ì¢…ë£Œì¼': l.endDate, 'ê³„ì•½ì›”ìˆ˜': l.leaseTerm,
        'íšŒì°¨ë³„ë¦¬ìŠ¤ë£Œ': parseFloat(l.monthlyPayment), 'ë‚©ë¶€ì£¼ê¸°ì›”ìˆ˜': l.paymentFrequency,
        'ë‚©ë¶€ë°©ì‹': l.paymentTiming === 'prepaid' ? 'ì„ ê¸‰' : 'í›„ê¸‰',
        'ì¦ë¶„ì°¨ì…ì´ììœ¨(%)': parseFloat(l.ibrRate),
        'ì„ ê¸‰ë¦¬ìŠ¤ë£Œ': parseFloat(l.prepaidLease), 'ì´ˆê¸°ì§ì ‘ì›ê°€': parseFloat(l.initialDirectCost),
        'ë¦¬ìŠ¤ì¸ì„¼í‹°ë¸Œ': parseFloat(l.leaseIncentive), 'ì”ì¡´ê°€ì¹˜ë³´ì¦': parseFloat(l.residualValue),
        'ë³€ê²½ê³„ì•½': l.isModification ? 'Y' : 'N',
        'ë¶€ëª¨ë¦¬ìŠ¤ID': l.parentLeaseId || '', 'ë¶€ëª¨ë²„ì „': l.parentVersion || 0,
        'ì´ì›”ë¶€ì±„': parseFloat(l.carriedOverLiability || 0),
        'ì´ì›”ìì‚°': parseFloat(l.carriedOverROU || 0),
        'ì´ì›”ì·¨ë“ê°€ì•¡': parseFloat(l.carriedOverAssetCost || 0),
        'ì´ì›”ê°ê°€ìƒê°ëˆ„ê³„ì•¡': parseFloat(l.carriedOverAccumDepreciation || 0),
        'ì „ëŒ€ë¦¬ìŠ¤ì—¬ë¶€': l.isSublease ? 'Y' : 'N',
        'ì „ëŒ€ìœ í˜•': l.subleaseType || '',
        'ì „ëŒ€ì‹œì‘ì¼': l.subleaseStartDate || '',
        'ë¹„ê³ ': l.notes || ''
      }));

      const ws1 = XLSX.utils.json_to_sheet(masterData);
      const ws2 = XLSX.utils.json_to_sheet(activeLeases.map(l => {
        const c = l.calculatedData;
        return {
          'ë¦¬ìŠ¤ID': l.lease_id, 'ë¦¬ìŠ¤ëª…': l.leaseName,
          'ì´ˆê¸°ë¶€ì±„': c?.initialLiability || 0,
          'ì´ˆê¸°ìì‚°': c?.initialROU || 0,
          'ì›”ê°ê°€ìƒê°': c?.monthlyDepreciation || 0
        };
      }));
      const ws3 = XLSX.utils.aoa_to_sheet([
        ['ë°±ì—…ì¼ì‹œ', new Date().toISOString()],
        ['ì´ ë¦¬ìŠ¤ ìˆ˜', leases.length],
        ['í™œì„± ë¦¬ìŠ¤ ìˆ˜', activeLeases.length]
      ]);

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws1, 'ë¦¬ìŠ¤ ë§ˆìŠ¤í„°');
      XLSX.utils.book_append_sheet(wb, ws2, 'ì´ˆê¸°ì¸¡ì •');
      XLSX.utils.book_append_sheet(wb, ws3, 'ë©”íƒ€ë°ì´í„°');
      XLSX.writeFile(wb, `IFRS16_ë°±ì—…_${new Date().toISOString().split('T')[0]}.xlsx`);
      alert('âœ… ë°±ì—… ì™„ë£Œ!');
    } catch(err) {
      alert(`ë°±ì—… ì‹¤íŒ¨: ${err.message}`);
    }
  };

  const importExcel = (e) => {
    const file = e.target.files[0]; 
    if(!file) return;
    
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const wb = XLSX.read(ev.target.result, {type:'binary'});
        const isBackup = wb.SheetNames.includes('ë©”íƒ€ë°ì´í„°') && wb.SheetNames.includes('ì´ˆê¸°ì¸¡ì •');

        if (isBackup) {
          const masterRows = XLSX.utils.sheet_to_json(wb.Sheets['ë¦¬ìŠ¤ ë§ˆìŠ¤í„°']);
          if (!window.confirm(`ë°±ì—… ë³µì›: ${masterRows.length}ê±´\nê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™” í›„ ë³µì›?`)) { 
            e.target.value=''; 
            return; 
          }

          const restored = masterRows.map(m => {
            return {
              lease_id: m['ë¦¬ìŠ¤ID'], version: m['ë²„ì „'],
              status: m['ìƒíƒœ']==='í™œì„±'?'active':'superseded',
              assetCategory: m['êµ¬ë¶„'], leaseName: m['ë¦¬ìŠ¤ëª…'],
              department: String(m['ë¶€ì„œ']||''), assetDetail: String(m['ìì‚°ì„¸ë¶€ë‚´ì—­']||''),
              startDate: parseDate(m['ì‹œì‘ì¼']), endDate: parseDate(m['ì¢…ë£Œì¼']),
              leaseTerm: m['ê³„ì•½ì›”ìˆ˜'] ? String(m['ê³„ì•½ì›”ìˆ˜']) : '',
              monthlyPayment: String(m['íšŒì°¨ë³„ë¦¬ìŠ¤ë£Œ']||0),
              paymentFrequency: parseInt(m['ë‚©ë¶€ì£¼ê¸°ì›”ìˆ˜']||1),
              paymentTiming: m['ë‚©ë¶€ë°©ì‹']==='í›„ê¸‰'?'postpaid':'prepaid',
              ibrRate: String(m['ì¦ë¶„ì°¨ì…ì´ììœ¨(%)']||0),
              isModification: m['ë³€ê²½ê³„ì•½']==='Y',
              parentLeaseId: String(m['ë¶€ëª¨ë¦¬ìŠ¤ID']||''), parentVersion: Number(m['ë¶€ëª¨ë²„ì „'])||0,
              carriedOverLiability: String(m['ì´ì›”ë¶€ì±„']||''), carriedOverROU: String(m['ì´ì›”ìì‚°']||''),
              carriedOverAssetCost: String(m['ì´ì›”ì·¨ë“ê°€ì•¡']||''), carriedOverAccumDepreciation: String(m['ì´ì›”ê°ê°€ìƒê°ëˆ„ê³„ì•¡']||''),
              prepaidLease: String(m['ì„ ê¸‰ë¦¬ìŠ¤ë£Œ']||'0'), initialDirectCost: String(m['ì´ˆê¸°ì§ì ‘ì›ê°€']||'0'),
              leaseIncentive: String(m['ë¦¬ìŠ¤ì¸ì„¼í‹°ë¸Œ']||'0'), residualValue: String(m['ì”ì¡´ê°€ì¹˜ë³´ì¦']||'0'),
              isSublease: m['ì „ëŒ€ë¦¬ìŠ¤ì—¬ë¶€']==='Y', 
              subleaseType: m['ì „ëŒ€ìœ í˜•']||'finance', 
              subleaseStartDate: parseDate(m['ì „ëŒ€ì‹œì‘ì¼'])||'',
              notes: String(m['ë¹„ê³ ']||''),
              calculatedData: null 
            };
          });
          const computed = restored.map(l => ({...l, calculatedData: computeLease(l)}));
          setLeases(computed);
          alert(`âœ… ë°±ì—… ë³µì› ì™„ë£Œ! ${computed.length}ê±´`);
        } else {
          const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
          const newLeases = [];
          
          rows.forEach(row => {
            if (!row['ë¦¬ìŠ¤ëª…']) return;
            
            const isMod = String(row['ë³€ê²½ê³„ì•½(Y/N)']||'').toUpperCase()==='Y';
            const isSub = String(row['ì „ëŒ€ë¦¬ìŠ¤ì—¬ë¶€(Y/N)']||'').toUpperCase()==='Y';
            
            const lease = {
              lease_id: (row['ë¦¬ìŠ¤ID'] && row['ë¦¬ìŠ¤ID']!=='ìë™ìƒì„±') 
                ? String(row['ë¦¬ìŠ¤ID']) 
                : genLeaseId(String(row['êµ¬ë¶„']||'ë¶€ë™ì‚°'), [...leases,...newLeases]),
              version: Number(row['ë²„ì „'])||1, 
              status:'active',
              assetCategory: String(row['êµ¬ë¶„']||'ë¶€ë™ì‚°'), 
              leaseName: String(row['ë¦¬ìŠ¤ëª…']),
              department: String(row['ì œì¶œë¶€ì„œ']||''), 
              assetDetail: String(row['ìì‚°ì„¸ë¶€ë‚´ì—­']||''),
              startDate: parseDate(row['ë¦¬ìŠ¤ì‹œì‘ì¼']), 
              endDate: parseDate(row['ë¦¬ìŠ¤ì¢…ë£Œì¼']),
              leaseTerm: row['ê³„ì•½ì›”ìˆ˜'] ? String(row['ê³„ì•½ì›”ìˆ˜']) : '', 
              monthlyPayment: String(row['íšŒì°¨ë³„ë¦¬ìŠ¤ë£Œ']||0),
              paymentFrequency: parseInt(row['ë‚©ë¶€ì£¼ê¸°ì›”ìˆ˜']||1),
              paymentTiming: String(row['ë‚©ë¶€ë°©ì‹']||'').includes('í›„ê¸‰')?'postpaid':'prepaid',
              ibrRate: String(row['ì¦ë¶„ì°¨ì…ì´ììœ¨(%)']||0),
              isModification: isMod,
              parentLeaseId: String(row['ë¶€ëª¨ë¦¬ìŠ¤ID']||''), 
              parentVersion: Number(row['ë¶€ëª¨ë²„ì „'])||0,
              carriedOverLiability: String(row['ì´ì›”ë¶€ì±„']||''), 
              carriedOverROU: String(row['ì´ì›”ìì‚°']||''),
              carriedOverAssetCost: String(row['ì´ì›”ì·¨ë“ê°€ì•¡']||''), 
              carriedOverAccumDepreciation: String(row['ì´ì›”ê°ê°€ìƒê°ëˆ„ê³„ì•¡']||''),
              prepaidLease: String(row['ì„ ê¸‰ë¦¬ìŠ¤ë£Œ']||'0'), 
              initialDirectCost: String(row['ì´ˆê¸°ì§ì ‘ì›ê°€']||'0'),
              leaseIncentive: String(row['ë¦¬ìŠ¤ì¸ì„¼í‹°ë¸Œ']||'0'), 
              residualValue: String(row['ì”ì¡´ê°€ì¹˜ë³´ì¦']||'0'),
              isSublease: isSub, 
              subleaseType: row['ì „ëŒ€ìœ í˜•(finance/operating)'] || 'finance', 
              subleaseStartDate: parseDate(row['ì „ëŒ€ì‹œì‘ì¼']) || '',
              notes: String(row['ë¹„ê³ ']||''), 
              calculatedData: null
            };
            
            lease.calculatedData = computeLease(lease);
            if (lease.calculatedData.error) {
              console.warn(`ìŠ¤í‚µ: ${lease.leaseName} - ${lease.calculatedData.error}`);
              return;
            }
            newLeases.push(lease);
          });

          if (newLeases.length === 0) {
            alert('âš ï¸ ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            e.target.value='';
            return;
          }

          setLeases(prev => [...prev, ...newLeases]);
          alert(`âœ… ${newLeases.length}ê±´ ì¶”ê°€ ì™„ë£Œ!`);
        }
        e.target.value='';
      } catch(err) {
        alert(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${err.message}`);
        e.target.value='';
      }
    };
    reader.readAsBinaryString(file);
  };

  // ğŸ†• ê²°ì‚° ë³´ê³ ì„œ ë°ì´í„° ìƒì„±
  const annualReport = useMemo(() => 
    generateAnnualReport(leases, fiscalYear), 
    [leases, fiscalYear]
  );

  // ì‚¬ìš© ê°€ëŠ¥í•œ ì—°ë„ ëª©ë¡
  const availableYears = useMemo(() => {
    const years = new Set();
    leases.forEach(l => {
      if (l.startDate) {
        const year = new Date(l.startDate).getFullYear();
        years.add(year);
        years.add(year + 1);
        years.add(year + 2);
      }
    });
    return Array.from(years).sort((a, b) => b - a);
  }, [leases]);

  return (
    <div className="min-h-screen bg-slate-900 text-white p-4">
      <div className="max-w-7xl mx-auto">
        <div className="bg-gradient-to-r from-blue-600 to-purple-600 p-6 rounded-2xl mb-4">
          <h1 className="text-3xl font-bold">IFRS 16 ë¦¬ìŠ¤ ê³„ì‚°ê¸° v5.0</h1>
          <p className="text-blue-100 text-sm mt-1">ğŸ“‰ ê²°ì‚° ë³´ê³ ì„œ ê¸°ëŠ¥ ì¶”ê°€ (Roll-forward ìë™ ì§‘ê³„)</p>
        </div>

        <div className="grid grid-cols-4 gap-2 mb-4">
          <div className="bg-slate-800 p-3 rounded-lg border border-slate-700">
            <div className="text-slate-500 text-xs">ë“±ë¡ ë¦¬ìŠ¤</div>
            <div className="text-xl font-bold">{activeLeases.length} <span className="text-xs text-slate-600">í™œì„± / {leases.length} ì „ì²´</span></div>
          </div>
          <div className="bg-slate-800 p-3 rounded-lg border border-blue-900">
            <div className="text-blue-400 text-xs">ì´ ë¦¬ìŠ¤ë¶€ì±„ (í™œì„±)</div>
            <div className="text-lg font-bold">â‚©{fmt(totalLiab)}</div>
          </div>
          <div className="bg-slate-800 p-3 rounded-lg border border-slate-700">
            <div className="text-slate-500 text-xs">ë¦¬ìŠ¤ ê·¸ë£¹</div>
            <div className="text-xl font-bold">{Object.keys(leaseGroups).length} <span className="text-xs text-slate-600">ê±´</span></div>
          </div>
          <div className="bg-slate-800 p-3 rounded-lg border border-slate-700 flex flex-col gap-1 justify-center">
            <button onClick={downloadTemplate} className="bg-indigo-600 hover:bg-indigo-700 py-1.5 rounded text-xs transition">í…œí”Œë¦¿</button>
            <label className="bg-slate-700 hover:bg-slate-600 py-1.5 rounded text-center text-xs cursor-pointer transition">
              ì—‘ì…€ ì—…ë¡œë“œ
              <input type="file" onChange={importExcel} className="hidden" accept=".xlsx"/>
            </label>
            <button onClick={exportBackup} className="bg-green-700 hover:bg-green-800 py-1.5 rounded text-xs transition">ë°±ì—…</button>
            <button onClick={clearAllData} className="bg-red-900 hover:bg-red-800 py-1.5 rounded text-xs transition">ì „ì²´ ì´ˆê¸°í™”</button>
          </div>
        </div>

        <div className="flex gap-0.5 mb-3 border-b border-slate-700">
          {[
            {id:'input',label:'ğŸ“ ì…ë ¥'},
            {id:'list',label:'ğŸ“‹ ëª©ë¡'},
            {id:'calculation',label:'ğŸ“Š ê³„ì‚°'},
            {id:'comparison',label:'ğŸ”„ ì°¨ì•¡'},
            {id:'annual',label:'ğŸ“‰ ê²°ì‚°ë³´ê³ ì„œ'}
          ].map(t => (
            <button key={t.id} onClick={()=>setActiveTab(t.id)}
              className={`px-4 py-2 text-sm rounded-t-lg transition ${activeTab===t.id?'text-blue-400 border-b-2 border-blue-400 bg-slate-800':'text-slate-500 hover:text-slate-300'}`}>
              {t.label}
            </button>
          ))}
        </div>

        {activeTab==='input' && (
          <div className="bg-slate-800 p-5 rounded-xl border border-slate-700 space-y-4">
            <div className={`p-3 rounded-lg border cursor-pointer transition ${modMode?'bg-yellow-900/20 border-yellow-700':'bg-slate-700/30 border-slate-600'}`}
              onClick={()=>toggleModMode(!modMode)}>
              <div className="flex items-center gap-2">
                <div className={`w-10 h-5 rounded-full relative transition ${modMode?'bg-yellow-600':'bg-slate-600'}`}>
                  <div className={`w-4 h-4 bg-white rounded-full absolute top-0.5 transition-all ${modMode?'left-5':'left-0.5'}`}/>
                </div>
                <span className="font-semibold">ê¸°ì¡´ ë¦¬ìŠ¤ ë³€ê²½ ë“±ë¡</span>
                {modMode && <span className="text-xs bg-yellow-700 text-yellow-100 px-1.5 py-0.5 rounded">í™œì„±</span>}
              </div>
            </div>

            {modMode && (
              <div className="bg-yellow-900/15 border border-yellow-700/40 rounded-lg p-4 space-y-3">
                <div className="text-yellow-300 font-semibold text-sm">ğŸ“Œ ë³€ê²½ ëŒ€ìƒ ë¦¬ìŠ¤ ì„ íƒ</div>
                {activeLeases.length===0
                  ? <div className="text-slate-600 text-sm">í™œì„± ë¦¬ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                  : <div className="space-y-1.5">{activeLeases.map(l => (
                    <button key={`${l.lease_id}-v${l.version}`} onClick={()=>selectParent(l)}
                      className={`w-full text-left p-2.5 rounded-lg border transition text-sm ${selParent && selParent.lease_id===l.lease_id?'border-yellow-500 bg-yellow-900/30':'border-slate-600 bg-slate-700/40 hover:border-slate-500'}`}>
                      <div className="flex justify-between items-center">
                        <span className="font-bold">{l.leaseName}</span>
                        <span className="text-xs text-slate-400 font-mono">{l.lease_id} v{l.version}</span>
                      </div>
                      <div className="text-xs text-slate-500">{l.startDate} ~ {l.endDate} | â‚©{fmt(parseFloat(l.monthlyPayment))}/íšŒ</div>
                    </button>
                  ))}</div>
                }
                {selParent && (
                  <>
                    <div className="text-xs text-slate-500 mt-1">ğŸ‘‡ ë³€ê²½ì¼(ì‹œì‘ì¼) ì…ë ¥ í›„ ğŸ“ì”ì•¡ ì¡°íšŒ í´ë¦­</div>
                    <button onClick={fetchBalanceAtDate} 
                      className="w-full bg-yellow-700 hover:bg-yellow-600 py-2 rounded text-sm font-semibold transition">
                      ğŸ“ ë³€ê²½ ì „ì¼ ì”ì•¡ ì¡°íšŒ
                    </button>
                    <div className="grid grid-cols-2 gap-2">
                      {[
                        {key:'carriedOverLiability',label:'ì´ì›” ë¦¬ìŠ¤ë¶€ì±„ *'},
                        {key:'carriedOverROU',label:'ì´ì›” ì‚¬ìš©ê¶Œìì‚° *'}
                      ].map(({key,label})=>(
                        <div key={key}>
                          <label className="block text-xs text-yellow-400 mb-0.5">{label}</label>
                          <input type="number" className="w-full bg-slate-900 border border-slate-600 rounded p-1.5 text-sm"
                            value={form[key]} onChange={e=>setForm({...form,[key]:e.target.value})}/>
                        </div>
                      ))}
                    </div>
                  </>
                )}
              </div>
            )}

            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="block text-xs text-slate-400 mb-0.5">ìì‚° êµ¬ë¶„</label>
                <select className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm" value={form.assetCategory} onChange={e=>setForm({...form,assetCategory:e.target.value})}>
                  <option>ë¶€ë™ì‚°</option><option>ì°¨ëŸ‰ìš´ë°˜êµ¬</option><option>ê¸°ê³„ì¥ì¹˜</option><option>ë¹„í’ˆ</option>
                </select>
              </div>
              <div>
                <label className="block text-xs text-slate-400 mb-0.5">ë¦¬ìŠ¤ëª… *</label>
                <input className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm" value={form.leaseName} onChange={e=>setForm({...form,leaseName:e.target.value})} placeholder="ì˜ˆ: ë³¸ì‚¬ 3ì¸µ"/>
              </div>
              <div>
                <label className="block text-xs text-slate-400 mb-0.5">ë¦¬ìŠ¤ ì‹œì‘ì¼ *</label>
                <div className="space-y-1">
                  <input type="date" className="w-full bg-slate-900 border border-slate-600 rounded p-1.5 text-sm" value={form.startDate} onChange={e=>setForm({...form,startDate:e.target.value})}/>
                  <div className="flex gap-1 text-xs">
                    <button onClick={()=>setStartPreset('y')} className="bg-slate-700 px-2 py-0.5 rounded hover:bg-slate-600">ì˜¬í•´1/1</button>
                    <button onClick={()=>setStartPreset('m')} className="bg-slate-700 px-2 py-0.5 rounded hover:bg-slate-600">ì´ë‹¬1ì¼</button>
                  </div>
                </div>
              </div>
              <div>
                <label className="block text-xs text-slate-400 mb-0.5">ë¦¬ìŠ¤ ì¢…ë£Œì¼</label>
                <input type="date" className="w-full bg-slate-900 border border-slate-600 rounded p-1.5 text-sm" value={form.endDate} onChange={e=>setForm({...form,endDate:e.target.value})}/>
              </div>
              <div>
                <label className="block text-xs text-slate-400 mb-0.5">ê³„ì•½ ì›”ìˆ˜ (ì§ì ‘ ì…ë ¥)</label>
                <input type="number" className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm" value={form.leaseTerm} onChange={e=>setForm({...form,leaseTerm:e.target.value})} placeholder="ë¯¸ì…ë ¥ ì‹œ ë‚ ì§œë¡œ ê³„ì‚°"/>
              </div>
              <div>
                <label className="block text-xs text-slate-400 mb-0.5">íšŒì°¨ë³„ ë¦¬ìŠ¤ë£Œ *</label>
                <input type="number" className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm" value={form.monthlyPayment} onChange={e=>setForm({...form,monthlyPayment:e.target.value})} placeholder="ì˜ˆ: 5000000"/>
              </div>
              <div>
                <label className="block text-xs text-slate-400 mb-0.5">ë‚©ë¶€ ì£¼ê¸°</label>
                <select className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm" value={form.paymentFrequency} onChange={e=>setForm({...form,paymentFrequency:parseInt(e.target.value)})}>
                  {FREQ_OPTIONS.map(f => <option key={f.v} value={f.v}>{f.l}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-xs text-slate-400 mb-0.5">ë‚©ë¶€ ë°©ì‹</label>
                <select className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm" value={form.paymentTiming} onChange={e=>setForm({...form,paymentTiming:e.target.value})}>
                  <option value="prepaid">ì„ ê¸‰ (ê¸°ì´ˆ)</option>
                  <option value="postpaid">í›„ê¸‰ (ê¸°ë§)</option>
                </select>
              </div>
              <div>
                <label className="block text-xs text-slate-400 mb-0.5">ì¦ë¶„ì°¨ì…ì´ììœ¨ (%)</label>
                <input type="number" step="0.01" className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm" value={form.ibrRate} onChange={e=>setForm({...form,ibrRate:e.target.value})} placeholder="ì˜ˆ: 3.5"/>
              </div>
            </div>

            <div className="bg-slate-700/30 p-3 rounded-lg border border-slate-600">
              <div className="text-xs text-slate-400 mb-2 font-semibold">ì¶”ê°€ í•­ëª© (ì„ íƒ)</div>
              <div className="grid grid-cols-2 gap-2 text-xs">
                {[
                  {key:'prepaidLease',label:'ì„ ê¸‰ë¦¬ìŠ¤ë£Œ'},
                  {key:'initialDirectCost',label:'ì´ˆê¸°ì§ì ‘ì›ê°€'},
                  {key:'leaseIncentive',label:'ë¦¬ìŠ¤ì¸ì„¼í‹°ë¸Œ'},
                  {key:'residualValue',label:'ì”ì¡´ê°€ì¹˜ë³´ì¦'}
                ].map(({key,label})=>(
                  <div key={key}>
                    <label className="block text-slate-500 mb-0.5">{label}</label>
                    <input type="number" className="w-full bg-slate-900 border border-slate-600 rounded p-1.5 text-sm"
                      value={form[key]} onChange={e=>setForm({...form,[key]:e.target.value})}/>
                  </div>
                ))}
              </div>
            </div>

            <div className="bg-slate-700/30 p-3 rounded-lg border border-slate-600">
              <div className="flex items-center gap-2 mb-2">
                <input type="checkbox" checked={form.isSublease} onChange={e=>setForm({...form,isSublease:e.target.checked})}
                  className="w-4 h-4"/>
                <span className="text-xs font-semibold">ì „ëŒ€ë¦¬ìŠ¤ (Sublease)</span>
              </div>
              {form.isSublease && (
                <div className="grid grid-cols-2 gap-2 text-xs">
                  <div>
                    <label className="block text-slate-500 mb-0.5">ì „ëŒ€ ìœ í˜•</label>
                    <select className="w-full bg-slate-900 border border-slate-600 rounded p-1.5 text-sm"
                      value={form.subleaseType} onChange={e=>setForm({...form,subleaseType:e.target.value})}>
                      <option value="finance">ê¸ˆìœµë¦¬ìŠ¤</option>
                      <option value="operating">ìš´ìš©ë¦¬ìŠ¤</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-slate-500 mb-0.5">ì „ëŒ€ ì‹œì‘ì¼</label>
                    <input type="date" className="w-full bg-slate-900 border border-slate-600 rounded p-1.5 text-sm"
                      value={form.subleaseStartDate} onChange={e=>setForm({...form,subleaseStartDate:e.target.value})}/>
                  </div>
                </div>
              )}
            </div>

            <div>
              <label className="block text-xs text-slate-400 mb-0.5">ë¹„ê³ </label>
              <textarea className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-sm" rows="2"
                value={form.notes} onChange={e=>setForm({...form,notes:e.target.value})}/>
            </div>

            <button onClick={handleSubmit}
              className="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-lg text-lg font-bold transition">
              {modMode ? 'ğŸ”„ ë³€ê²½ ë¦¬ìŠ¤ ë“±ë¡' : 'â• ì‹ ê·œ ë¦¬ìŠ¤ ë“±ë¡'}
            </button>
          </div>
        )}

        {activeTab==='list' && (
          <div className="space-y-2">
            {activeLeases.length === 0 
              ? <div className="bg-slate-800 rounded-xl border border-slate-700 p-10 text-center text-slate-600">ë“±ë¡ëœ ë¦¬ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
              : activeLeases.map(l => (
                <div key={`${l.lease_id}-v${l.version}`} className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                  <div className="flex justify-between items-start mb-2">
                    <div>
                      <div className="flex items-center gap-2">
                        <span className="text-lg font-bold">{l.leaseName}</span>
                        <span className="text-xs bg-blue-900 text-blue-300 px-2 py-0.5 rounded">{l.assetCategory}</span>
                        {l.isModification && <span className="text-xs bg-yellow-900 text-yellow-300 px-2 py-0.5 rounded">ë³€ê²½</span>}
                        {l.isSublease && <span className="text-xs bg-orange-900 text-orange-300 px-2 py-0.5 rounded">ì „ëŒ€</span>}
                      </div>
                      <div className="text-xs text-slate-400 mt-0.5 font-mono">{l.lease_id} v{l.version}</div>
                    </div>
                    <div className="flex gap-1">
                      <button onClick={()=>setSelectedLease(l)} className="bg-blue-700 hover:bg-blue-600 px-3 py-1 rounded text-xs transition">ìƒì„¸</button>
                      <button onClick={()=>deleteLease(l.lease_id, l.version)} className="bg-red-800 hover:bg-red-700 px-3 py-1 rounded text-xs transition">ì‚­ì œ</button>
                    </div>
                  </div>
                  <div className="grid grid-cols-3 gap-2 text-sm">
                    <div><span className="text-slate-500">ê¸°ê°„:</span> {l.startDate} ~ {l.endDate}</div>
                    <div><span className="text-slate-500">ì›”ìˆ˜:</span> {l.calculatedData?.months || 0}ê°œì›”</div>
                    <div><span className="text-slate-500">ë¦¬ìŠ¤ë£Œ:</span> â‚©{fmt(parseFloat(l.monthlyPayment))}</div>
                  </div>
                </div>
              ))
            }
          </div>
        )}

        {activeTab==='calculation' && (() => {
          const lease = selectedLease || activeLeases[0];
          if (!lease) return <div className="bg-slate-800 rounded-xl border border-slate-700 p-10 text-center text-slate-600">ê³„ì‚°í•  ë¦¬ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>;
          
          const calc = lease.calculatedData;
          if (!calc) return <div className="bg-slate-800 rounded-xl border border-slate-700 p-10 text-center text-slate-600">ê³„ì‚° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>;
          if (calc.error) return <div className="bg-red-900/20 border border-red-700 rounded-xl p-10 text-center text-red-400">{calc.error}</div>;

          return (
            <div className="space-y-4">
              <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                <div className="flex items-center justify-between mb-3">
                  <div>
                    <div className="text-xl font-bold">{lease.leaseName}</div>
                    <div className="text-xs text-slate-400 font-mono">{lease.lease_id} v{lease.version}</div>
                  </div>
                  <select className="bg-slate-700 border border-slate-600 rounded px-3 py-1.5 text-sm"
                    value={selectedLease?.lease_id || lease.lease_id}
                    onChange={e => {
                      const l = activeLeases.find(x => x.lease_id === e.target.value);
                      setSelectedLease(l);
                    }}>
                    {activeLeases.map(l => <option key={`${l.lease_id}-v${l.version}`} value={l.lease_id}>{l.leaseName} ({l.lease_id} v{l.version})</option>)}
                  </select>
                </div>

                {lease.isModification && (
                   <div className="bg-yellow-900/20 border border-yellow-700 p-3 rounded-lg mb-3">
                     <div className="text-xs text-yellow-300 font-semibold mb-1.5">ğŸ”„ ë³€ê²½ ê³„ì•½ ì •ë³´</div>
                     <div className="grid grid-cols-2 gap-2 text-xs">
                       <div><span className="text-slate-500">ë¶€ëª¨ ë¦¬ìŠ¤:</span> {lease.parentLeaseId} v{lease.parentVersion}</div>
                       <div><span className="text-slate-500">ë³€ê²½ì¼:</span> {lease.startDate}</div>
                       <div><span className="text-slate-500">ì´ì›” ë¶€ì±„:</span> â‚©{fmt(parseFloat(lease.carriedOverLiability||0))}</div>
                       <div><span className="text-slate-500">ì´ì›” ìì‚°:</span> â‚©{fmt(parseFloat(lease.carriedOverROU||0))}</div>
                     </div>
                   </div>
                )}
              </div>

              <div className="grid grid-cols-4 gap-2">
                <div className="bg-slate-800 p-3 rounded-lg border border-blue-900"><div className="text-blue-400 text-xs">ì´ˆê¸° ë¦¬ìŠ¤ë¶€ì±„</div><div className="text-lg font-bold">â‚©{fmt(calc.initialLiability)}</div></div>
                <div className="bg-slate-800 p-3 rounded-lg border border-purple-900"><div className="text-purple-400 text-xs">ì´ˆê¸° ì‚¬ìš©ê¶Œìì‚°</div><div className="text-lg font-bold">â‚©{fmt(calc.initialROU)}</div></div>
                <div className="bg-slate-800 p-3 rounded-lg border border-slate-700"><div className="text-slate-400 text-xs">ì·¨ë“ê°€ì•¡</div><div className="text-lg font-bold">â‚©{fmt(calc.assetCost)}</div></div>
                <div className="bg-slate-800 p-3 rounded-lg border border-orange-900"><div className="text-orange-400 text-xs">ì›” ê°ê°€ìƒê°ë¹„</div><div className="text-lg font-bold">â‚©{fmt(calc.monthlyDepreciation)}</div></div>
              </div>

              {calc.cashFlows && calc.cashFlows.length > 0 && (
                <div className="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                  <div className="p-2.5 border-b border-slate-700 flex justify-between items-center cursor-pointer hover:bg-slate-700/30"
                    onClick={() => setShowCashFlows(!showCashFlows)}>
                    <span className="text-xs font-semibold text-slate-400">ğŸ’µ í˜„ê¸ˆíë¦„ ê²€ì¦</span>
                    <span className="text-xs text-slate-500">{showCashFlows ? 'â–¼' : 'â–¶'}</span>
                  </div>
                  {showCashFlows && (
                    <div className="p-3">
                      <table className="w-full text-xs">
                        <thead className="bg-slate-700/50 text-slate-400">
                          <tr><th className="p-1.5 text-center">ìˆœë²ˆ</th><th className="p-1.5">ì¼ì</th><th className="p-1.5 text-right">í˜„ê¸ˆíë¦„</th><th className="p-1.5">ì„¤ëª…</th></tr>
                        </thead>
                        <tbody>
                          {calc.cashFlows.map((cf, i) => (
                            <tr key={i} className="border-t border-slate-700/30">
                              <td className="p-1.5 text-center text-slate-500">{cf.seq}</td>
                              <td className="p-1.5 font-mono">{cf.date}</td>
                              <td className="p-1.5 text-right">{cf.amount > 0 ? 'â‚©'+fmt(cf.amount) : '-'}</td>
                              <td className="p-1.5 text-slate-500">{cf.description}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </div>
              )}

              {calc.isFinanceSublease && calc.subleaseSchedule && calc.subleaseSchedule.length > 0 && (
                <div className="bg-slate-800 rounded-xl border border-orange-700 overflow-hidden">
                  <div className="p-2.5 border-b border-orange-700 text-xs font-semibold text-orange-300">
                    ğŸ”„ ì „ëŒ€ë¦¬ìŠ¤ ì±„ê¶Œ ìŠ¤ì¼€ì¤„
                  </div>
                  <div className="overflow-x-auto">
                    <table className="w-full text-xs text-right">
                      <thead className="bg-orange-900/20 text-orange-300">
                        <tr><th className="p-1.5 text-center">íšŒì°¨</th><th className="p-1.5">ë‚ ì§œ</th><th className="p-1.5">ê¸°ì´ˆì±„ê¶Œ</th><th className="p-1.5">ì´ììˆ˜ìµ</th><th className="p-1.5">ìˆ˜ì·¨</th><th className="p-1.5">ì›ê¸ˆíšŒìˆ˜</th><th className="p-1.5">ê¸°ë§ì±„ê¶Œ</th></tr>
                      </thead>
                      <tbody>
                        {calc.subleaseSchedule.map((row, i) => (
                          <tr key={i} className="border-t border-orange-700/20">
                            <td className="p-1.5 text-center text-slate-500">{row.seq}</td>
                            <td className="p-1.5 text-center font-mono">{row.date}</td>
                            <td className="p-1.5">â‚©{fmt(row.beginReceivable)}</td>
                            <td className="p-1.5 text-green-400">â‚©{fmt(row.interestIncome)}</td>
                            <td className="p-1.5">â‚©{fmt(row.collection)}</td>
                            <td className="p-1.5 text-blue-400">â‚©{fmt(row.principalCollection)}</td>
                            <td className="p-1.5 text-orange-300 font-bold">â‚©{fmt(row.endReceivable)}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}

              <div className="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                <div className="p-2.5 border-b border-slate-700 text-xs font-semibold text-slate-400">
                  ğŸ“Š ìƒê° ìŠ¤ì¼€ì¤„
                </div>
                <div className="overflow-x-auto" style={{maxHeight:'400px'}}>
                  <table className="w-full text-xs text-right">
                    <thead className="bg-slate-700 text-slate-400" style={{position:'sticky',top:0}}>
                      <tr><th className="p-1.5 text-center">íšŒì°¨</th><th className="p-1.5 text-center">ë‚ ì§œ</th><th className="p-1.5">ê¸°ì´ˆë¶€ì±„</th><th className="p-1.5">ì´ìë¹„ìš©</th><th className="p-1.5">ì§€ê¸‰ì•¡</th><th className="p-1.5">ì›ê¸ˆ</th><th className="p-1.5">ê¸°ë§ë¶€ì±„</th><th className="p-1.5">ê°ê°€ìƒê°</th><th className="p-1.5">ì¥ë¶€ê°€ì•¡</th></tr>
                    </thead>
                    <tbody>{calc.schedule.map((r,i)=>(
                      <tr key={i} className={`border-t border-slate-700/40 hover:bg-slate-700/20 ${r.isSubleasePeriod?'opacity-50':''}`}>
                        <td className="p-1.5 text-center text-slate-500">{r.period}</td>
                        <td className="p-1.5 text-center text-slate-500">{r.paymentDate}</td>
                        <td className="p-1.5">{fmt(r.beginLiability)}</td>
                        <td className="p-1.5 text-orange-400">{fmt(r.interest)}</td>
                        <td className="p-1.5">{fmt(r.payment)}</td>
                        <td className="p-1.5 text-blue-400">{fmt(r.principal)}</td>
                        <td className="p-1.5 text-blue-300">{fmt(r.endLiability)}</td>
                        <td className="p-1.5 text-purple-400">{r.isSubleasePeriod?'-':fmt(r.monthlyDepreciation)}</td>
                        <td className="p-1.5 text-cyan-400 font-bold">{r.isSubleasePeriod?<span className="text-[10px]">ì œê±°</span>:fmt(r.netBookValue)}</td>
                      </tr>
                    ))}</tbody>
                  </table>
                </div>
              </div>
            </div>
          );
        })()}

        {activeTab==='comparison' && (() => {
          const multiVer = Object.entries(leaseGroups).filter(([,v])=>v.length>1);
          const curId = cmpId || multiVer[0]?.[0];
          const diffs = curId ? calcDiff(curId) : [];

          return (
            <div className="space-y-4">
              {multiVer.length===0
                ? <div className="bg-slate-800 rounded-xl border border-slate-700 p-10 text-center text-slate-600">ë³€ê²½ ì´ë ¥ ì—†ìŒ</div>
                : (<>
                  <div className="bg-slate-800 p-3 rounded-xl border border-slate-700">
                    <div className="text-xs text-slate-500 mb-1.5">ë¹„êµ ëŒ€ìƒ</div>
                    <div className="flex gap-2 flex-wrap">{multiVer.map(([id,vers])=>(
                      <button key={id} onClick={()=>setCmpId(id)}
                        className={`px-2.5 py-1.5 rounded-lg text-sm border transition ${curId===id?'bg-yellow-900/30 border-yellow-600':'bg-slate-700 border-slate-600 hover:border-slate-500'}`}>
                        <span className="font-mono text-xs mr-1.5">{id}</span>
                        {vers.find(v=>v.status==='active')?.leaseName}
                        <span className="text-slate-500 text-xs ml-1.5">({vers.length}ver)</span>
                      </button>
                    ))}</div>
                  </div>
                  {diffs.map((d,idx)=>(
                    <div key={idx} className="bg-slate-800 rounded-xl border border-slate-700 p-4">
                      <div className="flex items-center gap-2 mb-3">
                        <span className="text-sm font-bold">ë³€ê²½ {idx+1}ì°¨</span>
                        <span className="text-xs bg-slate-600 px-2 py-0.5 rounded">v{d.v1.version} â†’ v{d.v2.version}</span>
                        <span className="text-xs text-slate-500">ë³€ê²½ì¼: {d.modDate}</span>
                      </div>
                      <div className="grid grid-cols-2 gap-3">
                        <div className="bg-blue-900/15 border border-blue-800/50 p-3 rounded-lg">
                          <div className="text-xs text-blue-400 mb-1 font-semibold">ë¦¬ìŠ¤ë¶€ì±„</div>
                          <div className="flex justify-between text-sm"><span>êµ¬:</span><span>â‚©{fmt(d.liabBefore)}</span></div>
                          <div className="flex justify-between text-sm"><span>ì‹ :</span><span>â‚©{fmt(d.liabAfter)}</span></div>
                          <div className={`flex justify-between font-bold text-sm ${d.liabDiff>=0?'text-red-400':'text-green-400'}`}><span>ì°¨ì•¡:</span><span>â‚©{fmt(d.liabDiff)}</span></div>
                        </div>
                        <div className="bg-purple-900/15 border border-purple-800/50 p-3 rounded-lg">
                          <div className="text-xs text-purple-400 mb-1 font-semibold">ì‚¬ìš©ê¶Œìì‚°</div>
                          <div className="flex justify-between text-sm"><span>êµ¬:</span><span>â‚©{fmt(d.rouBefore)}</span></div>
                          <div className="flex justify-between text-sm"><span>ì‹ :</span><span>â‚©{fmt(d.rouAfter)}</span></div>
                          <div className={`flex justify-between font-bold text-sm ${d.rouDiff>=0?'text-red-400':'text-green-400'}`}><span>ì°¨ì•¡:</span><span>â‚©{fmt(d.rouDiff)}</span></div>
                        </div>
                      </div>
                    </div>
                  ))}
                </>)
              }
            </div>
          );
        })()}

        {/* ğŸ†• ê²°ì‚° ë³´ê³ ì„œ íƒ­ */}
        {activeTab==='annual' && (
          <div className="space-y-4">
            <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
              <div className="flex items-center justify-between">
                <div>
                  <h2 className="text-lg font-bold">ê²°ì‚° ì—°ë„ ì„ íƒ</h2>
                  <p className="text-xs text-slate-500 mt-0.5">í•´ë‹¹ ì—°ë„ì˜ ê¸°ì´ˆ/ê¸°ë§ ì”ì•¡ ë° ì¦ê° ë‚´ì—­ì„ ìë™ìœ¼ë¡œ ì§‘ê³„í•©ë‹ˆë‹¤</p>
                </div>
                <select 
                  className="bg-slate-700 border border-slate-600 rounded px-4 py-2 text-sm font-mono"
                  value={fiscalYear}
                  onChange={e => setFiscalYear(parseInt(e.target.value))}>
                  {availableYears.length === 0 ? (
                    <option>{new Date().getFullYear()}</option>
                  ) : (
                    availableYears.map(y => <option key={y} value={y}>{y}ë…„</option>)
                  )}
                </select>
              </div>
            </div>

            {Object.keys(annualReport).length === 0 ? (
              <div className="bg-slate-800 rounded-xl border border-slate-700 p-10 text-center text-slate-600">
                {fiscalYear}ë…„ì— í™œì„± ë¦¬ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤
              </div>
            ) : (
              <div className="space-y-4">
                {Object.entries(annualReport).map(([category, data]) => (
                  <div key={category} className="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
                    <div className="bg-gradient-to-r from-blue-900 to-purple-900 p-3 border-b border-slate-700">
                      <div className="flex items-center justify-between">
                        <h3 className="text-lg font-bold">{category}</h3>
                        <div className="flex gap-3 text-xs">
                          <span className="bg-green-900/30 text-green-300 px-2 py-1 rounded">ì‹ ê·œ {data.newLeases}ê±´</span>
                          <span className="bg-blue-900/30 text-blue-300 px-2 py-1 rounded">ê¸°ì¡´ {data.existingLeases}ê±´</span>
                        </div>
                      </div>
                    </div>

                    <div className="p-4 space-y-4">
                      {/* ë¦¬ìŠ¤ë¶€ì±„ Roll-forward */}
                      <div>
                        <h4 className="text-sm font-semibold text-blue-400 mb-2">ğŸ“Š ë¦¬ìŠ¤ë¶€ì±„ ì¦ê°í‘œ</h4>
                        <table className="w-full text-sm">
                          <thead className="bg-slate-700/50 text-slate-300">
                            <tr>
                              <th className="p-2 text-left">êµ¬ë¶„</th>
                              <th className="p-2 text-right">ê¸°ì´ˆê¸ˆì•¡</th>
                              <th className="p-2 text-right">ì¦ê°€</th>
                              <th className="p-2 text-right">ì´ìë¹„ìš©</th>
                              <th className="p-2 text-right">ê°ì†Œ(ìƒí™˜)</th>
                              <th className="p-2 text-right">ê¸°ë§ê¸ˆì•¡</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr className="border-t border-slate-700/30">
                              <td className="p-2 font-medium">ë¦¬ìŠ¤ë¶€ì±„</td>
                              <td className="p-2 text-right font-mono">â‚©{fmt(data.liability.begin)}</td>
                              <td className="p-2 text-right font-mono text-green-400">â‚©{fmt(data.liability.increase)}</td>
                              <td className="p-2 text-right font-mono text-orange-400">â‚©{fmt(data.liability.interest)}</td>
                              <td className="p-2 text-right font-mono text-red-400">â‚©{fmt(data.liability.decrease)}</td>
                              <td className="p-2 text-right font-mono font-bold text-blue-300">â‚©{fmt(data.liability.end)}</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>

                      {/* ì‚¬ìš©ê¶Œìì‚° Roll-forward */}
                      <div>
                        <h4 className="text-sm font-semibold text-purple-400 mb-2">ğŸ“Š ì‚¬ìš©ê¶Œìì‚° ì¦ê°í‘œ</h4>
                        <table className="w-full text-sm">
                          <thead className="bg-slate-700/50 text-slate-300">
                            <tr>
                              <th className="p-2 text-left">êµ¬ë¶„</th>
                              <th className="p-2 text-right">ê¸°ì´ˆê¸ˆì•¡</th>
                              <th className="p-2 text-right">ì¦ê°€</th>
                              <th className="p-2 text-right">ê°ê°€ìƒê°</th>
                              <th className="p-2 text-right">ê°ì†Œ</th>
                              <th className="p-2 text-right">ê¸°ë§ê¸ˆì•¡</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr className="border-t border-slate-700/30">
                              <td className="p-2 font-medium">ì‚¬ìš©ê¶Œìì‚°</td>
                              <td className="p-2 text-right font-mono">â‚©{fmt(data.rou.begin)}</td>
                              <td className="p-2 text-right font-mono text-green-400">â‚©{fmt(data.rou.increase)}</td>
                              <td className="p-2 text-right font-mono text-purple-400">â‚©{fmt(data.rou.depreciation)}</td>
                              <td className="p-2 text-right font-mono text-red-400">â‚©{fmt(data.rou.decrease)}</td>
                              <td className="p-2 text-right font-mono font-bold text-purple-300">â‚©{fmt(data.rou.end)}</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}
      </div>
    </div>
  );
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>
