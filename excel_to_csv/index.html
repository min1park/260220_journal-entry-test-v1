<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Excel â†’ CSV ë³€í™˜ê¸° (Access í˜¸í™˜)</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
    background: #f0f2f5;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .container {
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.08);
    max-width: 800px;
    width: 100%;
    padding: 40px;
  }
  h1 {
    font-size: 24px;
    color: #1a1a2e;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .subtitle {
    color: #888;
    font-size: 14px;
    margin-bottom: 32px;
  }

  /* Options */
  .options-bar {
    display: none;
    gap: 16px;
    margin-top: 20px;
    padding: 14px 18px;
    background: #fff8e1;
    border: 1px solid #ffe082;
    border-radius: 10px;
    flex-wrap: wrap;
    align-items: center;
  }
  .options-bar.show { display: flex; }
  .options-bar label {
    font-size: 13px;
    color: #555;
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
  }
  .options-bar input[type="number"] {
    width: 50px;
    padding: 4px 6px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 13px;
  }
  .opt-title {
    font-weight: 600;
    font-size: 13px;
    color: #e65100;
    margin-right: 4px;
  }

  /* Drop Zone */
  .drop-zone {
    border: 2px dashed #c5cae9;
    border-radius: 12px;
    padding: 48px 24px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: #fafbff;
  }
  .drop-zone:hover, .drop-zone.drag-over {
    border-color: #5c6bc0;
    background: #eef0ff;
  }
  .drop-zone-icon { font-size: 48px; margin-bottom: 12px; }
  .drop-zone-text { font-size: 16px; color: #555; margin-bottom: 8px; }
  .drop-zone-hint { font-size: 13px; color: #aaa; }
  .drop-zone input[type="file"] { display: none; }

  /* File Info */
  .file-info {
    display: none;
    margin-top: 24px;
    padding: 16px 20px;
    background: #f5f7fa;
    border-radius: 10px;
    border: 1px solid #e8ecf1;
  }
  .file-info.show { display: block; }
  .file-name { font-weight: 600; font-size: 15px; color: #333; margin-bottom: 4px; word-break: break-all; }
  .file-meta { font-size: 13px; color: #888; }

  /* Sheet Table */
  .sheet-section { display: none; margin-top: 24px; }
  .sheet-section.show { display: block; }
  .sheet-section h2 { font-size: 16px; color: #333; margin-bottom: 12px; }
  table { width: 100%; border-collapse: collapse; font-size: 14px; }
  thead th {
    background: #5c6bc0; color: #fff;
    padding: 10px 14px; text-align: left; font-weight: 500;
  }
  thead th:first-child { border-radius: 8px 0 0 0; }
  thead th:last-child { border-radius: 0 8px 0 0; }
  tbody td { padding: 10px 14px; border-bottom: 1px solid #eee; color: #444; }
  tbody tr:hover { background: #f9f9ff; }
  tbody tr:last-child td:first-child { border-radius: 0 0 0 8px; }
  tbody tr:last-child td:last-child { border-radius: 0 0 8px 0; }

  /* Buttons */
  .btn {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 7px 16px; border: none; border-radius: 6px;
    font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.15s;
  }
  .btn-download { background: #e8f5e9; color: #2e7d32; }
  .btn-download:hover { background: #c8e6c9; }
  .btn-all {
    background: #5c6bc0; color: #fff;
    padding: 12px 28px; font-size: 15px; border-radius: 10px; margin-top: 20px;
  }
  .btn-all:hover { background: #4a59b0; }
  .btn-reset {
    background: #fff; color: #888; border: 1px solid #ddd;
    padding: 12px 28px; font-size: 15px; border-radius: 10px;
    margin-top: 20px; margin-left: 10px;
  }
  .btn-reset:hover { background: #f5f5f5; }
  .actions { text-align: center; }

  /* Warning */
  .warn-box {
    display: none;
    margin-top: 16px;
    padding: 12px 16px;
    background: #fff3e0;
    border: 1px solid #ffcc80;
    border-radius: 8px;
    font-size: 13px;
    color: #e65100;
    line-height: 1.6;
  }
  .warn-box.show { display: block; }
  .warn-box strong { color: #bf360c; }
  .warn-item { margin: 2px 0; padding-left: 12px; }

  /* Preview */
  .preview-section { display: none; margin-top: 24px; }
  .preview-section.show { display: block; }
  .preview-section h3 { font-size: 14px; color: #555; margin-bottom: 8px; }
  .preview-wrap {
    overflow-x: auto; border: 1px solid #e0e0e0;
    border-radius: 8px; max-height: 280px; overflow-y: auto;
  }
  .preview-wrap table { font-size: 12px; min-width: 600px; }
  .preview-wrap thead th {
    background: #78909c; padding: 6px 10px;
    position: sticky; top: 0; z-index: 1;
  }
  .preview-wrap tbody td { padding: 5px 10px; white-space: nowrap; }
  .fixed-col { background: #e3f2fd !important; color: #1565c0 !important; font-weight: 600; }

  /* Toast */
  .toast {
    position: fixed; bottom: 30px; left: 50%;
    transform: translateX(-50%) translateY(80px);
    background: #333; color: #fff; padding: 12px 24px;
    border-radius: 8px; font-size: 14px; opacity: 0;
    transition: all 0.3s; z-index: 100;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>

<div class="container">
  <h1>Excel â†’ CSV ë³€í™˜ê¸°</h1>
  <p class="subtitle">.xlsx / .xls íŒŒì¼ì„ Access í˜¸í™˜ CSVë¡œ ë³€í™˜í•©ë‹ˆë‹¤ (ì¤‘ë³µ í•„ë“œëª… / ë¹ˆ í—¤ë” ìë™ ìˆ˜ì •)</p>

  <div class="drop-zone" id="dropZone">
    <div class="drop-zone-icon">ğŸ“‚</div>
    <div class="drop-zone-text">íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</div>
    <div class="drop-zone-hint">.xlsx, .xls íŒŒì¼ ì§€ì›</div>
    <input type="file" id="fileInput" accept=".xlsx,.xls">
  </div>

  <div class="file-info" id="fileInfo">
    <div class="file-name" id="fileName"></div>
    <div class="file-meta" id="fileMeta"></div>
  </div>

  <div class="options-bar" id="optionsBar">
    <span class="opt-title">ì˜µì…˜</span>
    <label>
      <input type="checkbox" id="chkFixHeaders" checked>
      ì¤‘ë³µ/ë¹ˆ í•„ë“œëª… ìë™ ìˆ˜ì •
    </label>
    <label>
      <input type="checkbox" id="chkSkipEmpty" checked>
      ë¹ˆ í–‰ ê±´ë„ˆë›°ê¸° (í—¤ë” ìë™ íƒì§€)
    </label>
    <label>
      <input type="checkbox" id="chkForceDouble" checked>
      ìˆ«ì â†’ Double ë³€í™˜ (Access ëŒ€ìš©ëŸ‰ ìˆ«ì í˜¸í™˜)
    </label>
  </div>

  <div class="warn-box" id="warnBox"></div>

  <div class="sheet-section" id="sheetSection">
    <h2>ì‹œíŠ¸ ëª©ë¡</h2>
    <table>
      <thead>
        <tr>
          <th>ì‹œíŠ¸ëª…</th>
          <th>í–‰</th>
          <th>ì—´</th>
          <th>ìˆ˜ì •ì‚¬í•­</th>
          <th>ë¯¸ë¦¬ë³´ê¸°</th>
          <th>ë‹¤ìš´ë¡œë“œ</th>
        </tr>
      </thead>
      <tbody id="sheetBody"></tbody>
    </table>
    <div class="actions">
      <button class="btn btn-all" id="btnDownloadAll">ì „ì²´ ë‹¤ìš´ë¡œë“œ</button>
      <button class="btn btn-reset" id="btnReset">ì´ˆê¸°í™”</button>
    </div>
  </div>

  <div class="preview-section" id="previewSection">
    <h3 id="previewTitle"></h3>
    <div class="preview-wrap" id="previewWrap"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const $ = id => document.getElementById(id);
const dropZone = $('dropZone'), fileInput = $('fileInput');
const fileInfo = $('fileInfo'), fileName = $('fileName'), fileMeta = $('fileMeta');
const sheetSection = $('sheetSection'), sheetBody = $('sheetBody');
const previewSection = $('previewSection'), previewTitle = $('previewTitle'), previewWrap = $('previewWrap');
const btnDownloadAll = $('btnDownloadAll'), btnReset = $('btnReset');
const optionsBar = $('optionsBar'), warnBox = $('warnBox');
const chkFixHeaders = $('chkFixHeaders'), chkSkipEmpty = $('chkSkipEmpty'), chkForceDouble = $('chkForceDouble');

let workbook = null;
let currentFileName = '';
let processedSheets = {};  // { sheetName: { headers, data, warnings, skippedRows } }

// â”€â”€â”€â”€â”€ Drop Zone â”€â”€â”€â”€â”€
dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop', e => {
  e.preventDefault(); dropZone.classList.remove('drag-over');
  if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0]); });

function handleFile(file) {
  const ext = file.name.split('.').pop().toLowerCase();
  if (!['xlsx', 'xls'].includes(ext)) { showToast('xlsx ë˜ëŠ” xls íŒŒì¼ë§Œ ì§€ì›í•©ë‹ˆë‹¤'); return; }

  currentFileName = file.name.replace(/\.[^.]+$/, '');
  const reader = new FileReader();
  reader.onload = e => {
    workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
    renderFileInfo(file);
    processAllSheets();
    renderSheets();
  };
  reader.readAsArrayBuffer(file);
}

function renderFileInfo(file) {
  const size = file.size < 1048576
    ? (file.size / 1024).toFixed(1) + ' KB'
    : (file.size / 1048576).toFixed(1) + ' MB';
  fileName.textContent = file.name;
  fileMeta.textContent = size + ' \xB7 ' + workbook.SheetNames.length + 'ê°œ ì‹œíŠ¸';
  fileInfo.classList.add('show');
  optionsBar.classList.add('show');
}

// â”€â”€â”€â”€â”€ Core: ì‹œíŠ¸ ë¶„ì„ & í—¤ë” ìˆ˜ì • â”€â”€â”€â”€â”€
function processAllSheets() {
  processedSheets = {};
  const doFix = chkFixHeaders.checked;
  const doSkip = chkSkipEmpty.checked;

  workbook.SheetNames.forEach(name => {
    const ws = workbook.Sheets[name];
    const raw = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '', raw: true });
    if (!raw.length) { processedSheets[name] = { headers: [], data: [], warnings: [], skippedRows: 0 }; return; }

    // 1) ë¹ˆ í–‰ ê±´ë„ˆë›°ê¸° â†’ ì‹¤ì œ í—¤ë” í–‰ ì°¾ê¸°
    let headerIdx = 0;
    if (doSkip) {
      headerIdx = findHeaderRow(raw);
    }

    const skippedRows = headerIdx;
    const headerRow = raw[headerIdx] || [];
    const dataRows = raw.slice(headerIdx + 1);

    // 2) í—¤ë” ìˆ˜ì •
    const warnings = [];
    let finalHeaders;

    if (doFix) {
      finalHeaders = fixHeaders(headerRow, warnings);
    } else {
      finalHeaders = headerRow.map(h => h === '' || h == null ? '' : String(h));
    }

    // 3) ìˆ«ì ì»¬ëŸ¼ íƒì§€ (Access Double ë³€í™˜ìš©)
    const numericCols = new Set();
    if (chkForceDouble.checked) {
      for (let c = 0; c < finalHeaders.length; c++) {
        let isNum = false;
        for (let r = 0; r < Math.min(dataRows.length, 50); r++) {
          const v = dataRows[r][c];
          if (v !== '' && v != null) {
            isNum = (typeof v === 'number');
            break;
          }
        }
        if (isNum) numericCols.add(c);
      }
    }

    processedSheets[name] = { headers: finalHeaders, data: dataRows, warnings, skippedRows, numericCols };
  });
}

// í—¤ë” í–‰ ìë™ íƒì§€: ì²« ë²ˆì§¸ "ì˜ë¯¸ ìˆëŠ”" í–‰ ì°¾ê¸°
function findHeaderRow(rows) {
  for (let i = 0; i < Math.min(rows.length, 10); i++) {
    const row = rows[i];
    // ì ˆë°˜ ì´ìƒ ì…€ì´ ë¹„ì–´ìˆì§€ ì•Šìœ¼ë©´ í—¤ë” í›„ë³´
    const filled = row.filter(c => c !== '' && c != null).length;
    if (filled >= Math.ceil(row.length * 0.4)) {
      return i;
    }
  }
  return 0;
}

// ì¤‘ë³µ/ë¹ˆ í—¤ë” ìˆ˜ì •
function fixHeaders(headerRow, warnings) {
  const seen = {};
  return headerRow.map((h, i) => {
    let name = (h === '' || h == null) ? '' : String(h);

    // ë¹ˆ í—¤ë” â†’ Column_N
    if (name.trim() === '') {
      name = 'Column_' + (i + 1);
      warnings.push('ì—´ ' + (i + 1) + ': ë¹ˆ í—¤ë” â†’ ' + name);
    }

    // ìˆ«ìë¡œë§Œ ëœ í•„ë“œëª… â†’ ì•ì— M ì ‘ë‘ì‚¬ (Access ê¸ˆì§€)
    if (/^-?\d+\.?\d*$/.test(name)) {
      const orig = name;
      name = 'M' + name;
      warnings.push('ì—´ ' + (i + 1) + ': ìˆ«ì í—¤ë” "' + orig + '" â†’ "' + name + '"');
    }

    // Access ê¸ˆì§€ ë¬¸ì ì œê±°: . ! ` [ ]
    const cleaned = name.replace(/[.!`\[\]]/g, '_');
    if (cleaned !== name) {
      warnings.push('ì—´ ' + (i + 1) + ': íŠ¹ìˆ˜ë¬¸ì ì œê±° "' + name + '" â†’ "' + cleaned + '"');
      name = cleaned;
    }

    // 64ì ì´ˆê³¼ ìë¥´ê¸°
    if (name.length > 64) {
      name = name.substring(0, 60) + '_' + (i + 1);
      warnings.push('ì—´ ' + (i + 1) + ': ì´ë¦„ ê¸¸ì´ ì´ˆê³¼ â†’ ì˜ë¼ëƒ„');
    }

    // ì¤‘ë³µ ì²˜ë¦¬
    if (name in seen) {
      seen[name]++;
      const newName = name + '_' + seen[name];
      warnings.push('ì—´ ' + (i + 1) + ': ì¤‘ë³µ "' + name + '" â†’ "' + newName + '"');
      name = newName;
    } else {
      seen[name] = 1;
    }

    return name;
  });
}

// â”€â”€â”€â”€â”€ Render â”€â”€â”€â”€â”€
function renderSheets() {
  sheetBody.innerHTML = '';
  previewSection.classList.remove('show');
  warnBox.classList.remove('show');

  let allWarnings = [];

  workbook.SheetNames.forEach(name => {
    const info = processedSheets[name];
    const rows = info.data.length;
    const cols = info.headers.length;

    const numColNames = [...(info.numericCols || [])].map(i => info.headers[i]);
    const sheetWarnings = [...info.warnings];
    if (numColNames.length > 0) {
      sheetWarnings.push('Double ë³€í™˜ ì ìš©: ' + numColNames.join(', '));
    }
    if (sheetWarnings.length > 0) {
      allWarnings.push({ sheet: name, items: sheetWarnings });
    }

    const tr = document.createElement('tr');
    const warnCount = sheetWarnings.length;
    const warnBadge = warnCount > 0
      ? '<span style="background:#fff3e0;color:#e65100;padding:2px 8px;border-radius:4px;font-size:12px;">' + warnCount + 'ê±´ ìˆ˜ì •</span>'
      : '<span style="color:#4caf50;font-size:12px;">ì—†ìŒ</span>';

    tr.innerHTML =
      '<td><strong>' + name + '</strong>' + (info.skippedRows > 0 ? ' <span style="font-size:11px;color:#999;">(ìƒë‹¨ ' + info.skippedRows + 'í–‰ ê±´ë„ˆëœ€)</span>' : '') + '</td>' +
      '<td>' + rows.toLocaleString() + '</td>' +
      '<td>' + cols + '</td>' +
      '<td>' + warnBadge + '</td>' +
      '<td><button class="btn btn-download" data-action="preview" data-sheet="' + name + '">ë³´ê¸°</button></td>' +
      '<td><button class="btn btn-download" data-action="download" data-sheet="' + name + '">CSV</button></td>';
    sheetBody.appendChild(tr);
  });

  // ì´ë²¤íŠ¸ ìœ„ì„
  sheetBody.onclick = e => {
    const btn = e.target.closest('[data-action]');
    if (!btn) return;
    const sheet = btn.dataset.sheet;
    if (btn.dataset.action === 'preview') showPreview(sheet);
    else if (btn.dataset.action === 'download') downloadSheet(sheet);
  };

  // ê²½ê³  í‘œì‹œ
  if (allWarnings.length > 0) {
    let html = '<strong>ìë™ ìˆ˜ì •ëœ í•„ë“œëª…:</strong><br>';
    allWarnings.forEach(w => {
      html += '<br><strong>[' + w.sheet + ']</strong><br>';
      w.items.forEach(item => { html += '<div class="warn-item">' + item + '</div>'; });
    });
    warnBox.innerHTML = html;
    warnBox.classList.add('show');
  }

  sheetSection.classList.add('show');
}

// â”€â”€â”€â”€â”€ CSV ìƒì„± (ìˆ˜ì •ëœ í—¤ë” ì ìš©) â”€â”€â”€â”€â”€
function buildCSV(sheetName) {
  const info = processedSheets[sheetName];
  const numCols = info.numericCols || new Set();

  function formatCell(cell, colIdx, isHeader) {
    if (cell === '' || cell == null) return '';
    // ìˆ«ì ì»¬ëŸ¼ + ë°ì´í„°í–‰ â†’ .0 ë¶™ì—¬ì„œ Accessê°€ Doubleë¡œ ì¸ì‹
    if (!isHeader && numCols.has(colIdx) && typeof cell === 'number') {
      return Number.isInteger(cell) ? cell + '.0' : String(cell);
    }
    const s = String(cell);
    if (s.includes(',') || s.includes('"') || s.includes('\n')) {
      return '"' + s.replace(/"/g, '""') + '"';
    }
    return s;
  }

  let lines = [];
  // Header
  lines.push(info.headers.map((h, i) => formatCell(h, i, true)).join(','));
  // Data
  info.data.forEach(row => {
    lines.push(row.map((cell, i) => formatCell(cell, i, false)).join(','));
  });
  return lines.join('\r\n');
}

function downloadSheet(sheetName) {
  const csv = buildCSV(sheetName);
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  downloadBlob(blob, currentFileName + '_' + sheetName + '.csv');
  showToast('"' + sheetName + '" ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
}

function downloadBlob(blob, name) {
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(a.href);
}

btnDownloadAll.addEventListener('click', () => {
  workbook.SheetNames.forEach(name => downloadSheet(name));
  showToast('ì „ì²´ ì‹œíŠ¸ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ');
});

btnReset.addEventListener('click', () => {
  workbook = null; currentFileName = ''; processedSheets = {};
  fileInput.value = '';
  fileInfo.classList.remove('show');
  sheetSection.classList.remove('show');
  previewSection.classList.remove('show');
  optionsBar.classList.remove('show');
  warnBox.classList.remove('show');
});

// ì˜µì…˜ ë³€ê²½ ì‹œ ì¬ì²˜ë¦¬
chkFixHeaders.addEventListener('change', () => { if (workbook) { processAllSheets(); renderSheets(); } });
chkSkipEmpty.addEventListener('change', () => { if (workbook) { processAllSheets(); renderSheets(); } });
chkForceDouble.addEventListener('change', () => { if (workbook) { processAllSheets(); renderSheets(); } });

// â”€â”€â”€â”€â”€ Preview â”€â”€â”€â”€â”€
function showPreview(sheetName) {
  const info = processedSheets[sheetName];
  const maxRows = Math.min(info.data.length, 20);

  previewTitle.textContent = '"' + sheetName + '" ë¯¸ë¦¬ë³´ê¸° (ì²˜ìŒ ' + maxRows + 'í–‰)';

  let html = '<table><thead><tr>';
  info.headers.forEach((h, i) => {
    // ìˆ˜ì •ëœ í—¤ë”ëŠ” í•˜ì´ë¼ì´íŠ¸
    const orig = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1, defval: '' })[info.skippedRows];
    const wasFixed = orig && String(orig[i] || '') !== h;
    html += '<th' + (wasFixed ? ' class="fixed-col" title="ì›ë³¸: ' + (orig[i] || '(ë¹ˆê°’)') + '"' : '') + '>' + h + '</th>';
  });
  html += '</tr></thead><tbody>';

  for (let r = 0; r < maxRows; r++) {
    html += '<tr>';
    const row = info.data[r] || [];
    for (let c = 0; c < info.headers.length; c++) {
      const v = row[c] !== undefined && row[c] !== null ? row[c] : '';
      html += '<td>' + v + '</td>';
    }
    html += '</tr>';
  }
  html += '</tbody></table>';

  previewWrap.innerHTML = html;
  previewSection.classList.add('show');
  previewSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function showToast(msg) {
  const t = $('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}
</script>

</body>
</html>
