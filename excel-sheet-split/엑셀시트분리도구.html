<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì—‘ì…€ ì‹œíŠ¸ ë¶„ë¦¬ ë„êµ¬</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Segoe UI', 'Malgun Gothic', 'ë§‘ì€ ê³ ë”•', sans-serif;
    background: #f0f2f5;
    color: #333;
    min-height: 100vh;
  }

  .container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 30px 20px;
  }

  header {
    text-align: center;
    margin-bottom: 30px;
  }

  header h1 {
    font-size: 28px;
    color: #1a73e8;
    margin-bottom: 8px;
  }

  header p {
    color: #666;
    font-size: 14px;
  }

  .card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    padding: 28px;
    margin-bottom: 20px;
  }

  .card h2 {
    font-size: 18px;
    color: #333;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .step-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: #1a73e8;
    color: #fff;
    font-size: 14px;
    font-weight: 700;
    flex-shrink: 0;
  }

  /* Upload Area */
  .upload-area {
    border: 2px dashed #ccc;
    border-radius: 10px;
    padding: 40px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: #fafbfc;
  }

  .upload-area:hover, .upload-area.dragover {
    border-color: #1a73e8;
    background: #e8f0fe;
  }

  .upload-area.has-file {
    border-color: #34a853;
    background: #e6f4ea;
  }

  .upload-icon {
    font-size: 48px;
    margin-bottom: 12px;
  }

  .upload-area p {
    color: #666;
    font-size: 14px;
  }

  .upload-area .file-name {
    color: #1a73e8;
    font-weight: 600;
    font-size: 16px;
    margin-top: 8px;
  }

  #fileInput { display: none; }

  /* Sheet Selection */
  .sheet-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .sheet-btn {
    padding: 8px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    background: #fff;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.15s;
    color: #333;
  }

  .sheet-btn:hover {
    border-color: #1a73e8;
    background: #e8f0fe;
  }

  .sheet-btn.selected {
    border-color: #1a73e8;
    background: #1a73e8;
    color: #fff;
    font-weight: 600;
  }

  /* Settings */
  .settings-row {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    align-items: flex-end;
  }

  .setting-group {
    flex: 1;
    min-width: 200px;
  }

  .setting-group label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: #555;
    margin-bottom: 6px;
  }

  .setting-group input,
  .setting-group select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
    background: #fafbfc;
    transition: border-color 0.15s;
  }

  .setting-group input:focus,
  .setting-group select:focus {
    outline: none;
    border-color: #1a73e8;
    background: #fff;
  }

  .help-text {
    font-size: 12px;
    color: #888;
    margin-top: 4px;
  }

  /* Section Preview Table */
  .section-table-wrap {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
  }

  .section-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  .section-table thead {
    position: sticky;
    top: 0;
    z-index: 1;
  }

  .section-table th {
    background: #f5f5f5;
    padding: 10px 14px;
    text-align: left;
    font-weight: 600;
    color: #555;
    border-bottom: 2px solid #e0e0e0;
  }

  .section-table td {
    padding: 9px 14px;
    border-bottom: 1px solid #f0f0f0;
  }

  .section-table tr:hover td {
    background: #f8f9fa;
  }

  .section-table .num {
    color: #1a73e8;
    font-weight: 700;
    text-align: center;
    width: 50px;
  }

  .section-table .rows {
    text-align: center;
    width: 80px;
    color: #666;
  }

  .section-table .range {
    text-align: center;
    width: 120px;
    color: #888;
    font-size: 12px;
  }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 28px;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .btn-primary {
    background: #1a73e8;
    color: #fff;
  }

  .btn-primary:hover:not(:disabled) {
    background: #1557b0;
    box-shadow: 0 2px 8px rgba(26,115,232,0.3);
  }

  .btn-success {
    background: #34a853;
    color: #fff;
  }

  .btn-success:hover:not(:disabled) {
    background: #2d8e47;
  }

  .btn-outline {
    background: #fff;
    color: #1a73e8;
    border: 2px solid #1a73e8;
  }

  .btn-outline:hover:not(:disabled) {
    background: #e8f0fe;
  }

  .actions {
    display: flex;
    gap: 12px;
    margin-top: 20px;
    flex-wrap: wrap;
  }

  /* Progress */
  .progress-bar {
    width: 100%;
    height: 6px;
    background: #e0e0e0;
    border-radius: 3px;
    overflow: hidden;
    margin-top: 16px;
    display: none;
  }

  .progress-bar .fill {
    height: 100%;
    background: linear-gradient(90deg, #1a73e8, #34a853);
    border-radius: 3px;
    transition: width 0.3s;
    width: 0%;
  }

  .status-text {
    font-size: 13px;
    color: #666;
    margin-top: 8px;
    display: none;
  }

  /* Summary */
  .summary-stats {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    margin-bottom: 16px;
  }

  .stat-box {
    flex: 1;
    min-width: 120px;
    background: #f8f9fa;
    border-radius: 8px;
    padding: 16px;
    text-align: center;
  }

  .stat-box .value {
    font-size: 28px;
    font-weight: 700;
    color: #1a73e8;
  }

  .stat-box .label {
    font-size: 12px;
    color: #888;
    margin-top: 4px;
  }

  .hidden { display: none !important; }

  /* Checkbox styling */
  .checkbox-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 12px;
  }

  .checkbox-row input[type="checkbox"] {
    width: 18px;
    height: 18px;
    accent-color: #1a73e8;
  }

  .checkbox-row label {
    font-size: 13px;
    color: #555;
  }

  /* Toast notification */
  .toast {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: #323232;
    color: #fff;
    padding: 14px 24px;
    border-radius: 8px;
    font-size: 14px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
    transform: translateY(100px);
    opacity: 0;
    transition: all 0.3s;
    z-index: 1000;
  }

  .toast.show {
    transform: translateY(0);
    opacity: 1;
  }

  /* Guide Section */
  .guide-card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    margin-bottom: 20px;
    overflow: hidden;
  }

  .guide-toggle {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 18px 28px;
    border: none;
    background: linear-gradient(135deg, #e8f0fe 0%, #f0f4ff 100%);
    cursor: pointer;
    transition: background 0.2s;
  }

  .guide-toggle:hover {
    background: linear-gradient(135deg, #d2e3fc 0%, #e8f0fe 100%);
  }

  .guide-toggle-left {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 16px;
    font-weight: 700;
    color: #1a73e8;
  }

  .guide-arrow {
    font-size: 14px;
    color: #1a73e8;
    transition: transform 0.3s;
  }

  .guide-arrow.open {
    transform: rotate(180deg);
  }

  .guide-body {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease, padding 0.3s ease;
    padding: 0 28px;
  }

  .guide-body.open {
    max-height: 2000px;
    padding: 0 28px 28px 28px;
  }

  .guide-body h3 {
    font-size: 15px;
    color: #1a73e8;
    margin: 20px 0 10px 0;
    padding-bottom: 6px;
    border-bottom: 2px solid #e8f0fe;
  }

  .guide-body h3:first-child {
    margin-top: 8px;
  }

  .guide-steps {
    list-style: none;
    padding: 0;
  }

  .guide-steps li {
    display: flex;
    gap: 12px;
    padding: 10px 0;
    border-bottom: 1px solid #f5f5f5;
    font-size: 13.5px;
    line-height: 1.6;
    color: #444;
  }

  .guide-steps li:last-child {
    border-bottom: none;
  }

  .guide-step-num {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 26px;
    height: 26px;
    border-radius: 50%;
    background: #1a73e8;
    color: #fff;
    font-size: 13px;
    font-weight: 700;
    flex-shrink: 0;
    margin-top: 1px;
  }

  .guide-steps li strong {
    color: #333;
  }

  .guide-patterns {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    margin-top: 6px;
  }

  .guide-patterns th {
    background: #f5f7fa;
    padding: 8px 12px;
    text-align: left;
    font-weight: 600;
    color: #555;
    border-bottom: 2px solid #e0e0e0;
  }

  .guide-patterns td {
    padding: 7px 12px;
    border-bottom: 1px solid #f0f0f0;
    color: #555;
  }

  .guide-patterns code {
    background: #f0f2f5;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Consolas', 'Courier New', monospace;
    font-size: 12px;
    color: #d63384;
  }

  .guide-tip {
    background: #fff8e1;
    border-left: 4px solid #ffc107;
    padding: 12px 16px;
    border-radius: 0 8px 8px 0;
    margin-top: 12px;
    font-size: 13px;
    color: #665500;
    line-height: 1.6;
  }

  .guide-tip strong {
    color: #e65100;
  }

  .guide-note {
    background: #e8f5e9;
    border-left: 4px solid #4caf50;
    padding: 12px 16px;
    border-radius: 0 8px 8px 0;
    margin-top: 12px;
    font-size: 13px;
    color: #2e7d32;
    line-height: 1.6;
  }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>ì—‘ì…€ ì‹œíŠ¸ ë¶„ë¦¬ ë„êµ¬</h1>
    <p>ì—‘ì…€ íŒŒì¼ì˜ íŠ¹ì • ì‹œíŠ¸ë¥¼ ì„¹ì…˜(ë²ˆí˜¸) ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¦¬í•˜ì—¬ ìƒˆ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤</p>
  </header>

  <!-- GUIDE -->
  <div class="guide-card">
    <button class="guide-toggle" onclick="toggleGuide()">
      <span class="guide-toggle-left">&#x1F4D6; ì‚¬ìš©ë²• ì•ˆë‚´</span>
      <span class="guide-arrow" id="guideArrow">&#9660;</span>
    </button>
    <div class="guide-body" id="guideBody">

      <h3>&#x1F680; ê¸°ë³¸ ì‚¬ìš©ë²• (4ë‹¨ê³„)</h3>
      <ol class="guide-steps">
        <li>
          <span class="guide-step-num">1</span>
          <span>
            <strong>ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</strong><br>
            ì•„ë˜ ì—…ë¡œë“œ ì˜ì—­ì„ í´ë¦­í•˜ê±°ë‚˜, íŒŒì¼ì„ ë“œë˜ê·¸ ì•¤ ë“œë¡­í•˜ì—¬ ì—…ë¡œë“œí•©ë‹ˆë‹¤.<br>
            <code>.xlsx</code>, <code>.xls</code> í˜•ì‹ì„ ì§€ì›í•©ë‹ˆë‹¤.
          </span>
        </li>
        <li>
          <span class="guide-step-num">2</span>
          <span>
            <strong>ë¶„ë¦¬í•  ì‹œíŠ¸ ì„ íƒ</strong><br>
            íŒŒì¼ì— í¬í•¨ëœ ì‹œíŠ¸ ëª©ë¡ì´ ë²„íŠ¼ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤. ë¶„ë¦¬í•˜ê³  ì‹¶ì€ ì‹œíŠ¸ë¥¼ í´ë¦­í•˜ì„¸ìš”.<br>
            (ì˜ˆ: "ë³„ë„ì£¼ì„", "ì—°ê²°ì£¼ì„" ë“±)
          </span>
        </li>
        <li>
          <span class="guide-step-num">3</span>
          <span>
            <strong>ë¶„ë¦¬ ì„¤ì • &amp; ì„¹ì…˜ ê°ì§€</strong><br>
            ì„¹ì…˜ í—¤ë”ë¥¼ ê°ì§€í•  <strong>íŒ¨í„´</strong>ê³¼ <strong>ê°ì§€ ì—´</strong>ì„ ì„ íƒí•œ í›„, <strong>[ì„¹ì…˜ ê°ì§€]</strong> ë²„íŠ¼ì„ í´ë¦­í•©ë‹ˆë‹¤.<br>
            ëŒ€ë¶€ë¶„ì˜ ì£¼ì„ ì‹œíŠ¸ëŠ” ê¸°ë³¸ê°’(ìˆ«ì. í…ìŠ¤íŠ¸ / Aì—´)ìœ¼ë¡œ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
          </span>
        </li>
        <li>
          <span class="guide-step-num">4</span>
          <span>
            <strong>ë¯¸ë¦¬ë³´ê¸° í™•ì¸ &amp; ë‹¤ìš´ë¡œë“œ</strong><br>
            ê°ì§€ëœ ì„¹ì…˜ ëª©ë¡ì„ ë¯¸ë¦¬ë³´ê¸°ì—ì„œ í™•ì¸í•©ë‹ˆë‹¤.<br>
            ì‹œíŠ¸ëª…, í–‰ ë²”ìœ„, í–‰ ìˆ˜ê°€ ì •í™•í•œì§€ í™•ì¸ í›„ <strong>[ë¶„ë¦¬ &amp; ë‹¤ìš´ë¡œë“œ]</strong> ë²„íŠ¼ì„ í´ë¦­í•˜ë©´<br>
            ê° ì„¹ì…˜ì´ ë³„ë„ ì‹œíŠ¸ë¡œ ë¶„ë¦¬ëœ ìƒˆ ì—‘ì…€ íŒŒì¼ì´ ìë™ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤.
          </span>
        </li>
      </ol>

      <h3>&#x1F50D; ì§€ì›í•˜ëŠ” ì„¹ì…˜ ê°ì§€ íŒ¨í„´</h3>
      <table class="guide-patterns">
        <thead>
          <tr>
            <th style="width:200px;">íŒ¨í„´ ì´ë¦„</th>
            <th>ê°ì§€ ì˜ˆì‹œ</th>
            <th style="width:180px;">ì •ê·œì‹</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>ìˆ«ì. í…ìŠ¤íŠ¸</td>
            <td>1. ë‹¹ì‚¬ì˜ ê°œìš” / 25. ì£¼ì‹ê¸°ì¤€ë³´ìƒ</td>
            <td><code>^\d+\.\s+</code></td>
          </tr>
          <tr>
            <td>ìˆ«ì) í…ìŠ¤íŠ¸</td>
            <td>1) ê°œìš” / 5) ê¸ˆìœµìƒí’ˆ</td>
            <td><code>^\d+\)\s+</code></td>
          </tr>
          <tr>
            <td>(ìˆ«ì) í…ìŠ¤íŠ¸</td>
            <td>(1) ê°œìš” / (5) ê¸ˆìœµìƒí’ˆ</td>
            <td><code>^\(\d+\)\s+</code></td>
          </tr>
          <tr>
            <td>ë¡œë§ˆìˆ«ì. í…ìŠ¤íŠ¸</td>
            <td>I. ì„œë¡  / IV. ê²°ë¡ </td>
            <td><code>^[IVXLCDM]+\.\s+</code></td>
          </tr>
          <tr>
            <td>ì‚¬ìš©ì ì •ì˜</td>
            <td>ì§ì ‘ ì •ê·œì‹ ì…ë ¥</td>
            <td>ììœ  ì…ë ¥</td>
          </tr>
        </tbody>
      </table>

      <h3>&#x2699;&#xFE0F; ì„¤ì • ì˜µì…˜ ì•ˆë‚´</h3>
      <ol class="guide-steps">
        <li>
          <span class="guide-step-num">A</span>
          <span>
            <strong>ê°ì§€ ì—´</strong> &mdash; ì„¹ì…˜ ë²ˆí˜¸ê°€ ê¸°ì¬ëœ ì—´ì„ ì„ íƒí•©ë‹ˆë‹¤ (ê¸°ë³¸: Aì—´).<br>
            Bì—´ì´ë‚˜ Cì—´ì— ë²ˆí˜¸ê°€ ìˆëŠ” ê²½ìš° ë³€ê²½í•˜ì„¸ìš”.
          </span>
        </li>
        <li>
          <span class="guide-step-num">B</span>
          <span>
            <strong>ì„¹ì…˜ í—¤ë” í–‰ í¬í•¨</strong> &mdash; ì²´í¬ ì‹œ ê° ì‹œíŠ¸ì˜ ì²« í–‰ì— ì„¹ì…˜ ì œëª© í–‰ì´ í¬í•¨ë©ë‹ˆë‹¤.<br>
            ì²´í¬ í•´ì œ ì‹œ ì œëª© í–‰ ì—†ì´ ë°ì´í„°ë§Œ ë¶„ë¦¬ë©ë‹ˆë‹¤.
          </span>
        </li>
      </ol>

      <h3>&#x1F4C2; ì¶œë ¥ íŒŒì¼ ì•ˆë‚´</h3>
      <ol class="guide-steps">
        <li>
          <span class="guide-step-num">&#x2193;</span>
          <span>
            <strong>íŒŒì¼ëª… ê·œì¹™</strong> &mdash; <code>[ì›ë³¸íŒŒì¼ëª…]_[ì‹œíŠ¸ëª…]_ë¶„ë¦¬.xlsx</code> í˜•ì‹ìœ¼ë¡œ ìë™ ìƒì„±ë©ë‹ˆë‹¤.<br>
            ì˜ˆ: <code>ì •ì‚°í‘œV3_ë³„ë„ì£¼ì„_ë¶„ë¦¬.xlsx</code>
          </span>
        </li>
        <li>
          <span class="guide-step-num">&#x1F4CB;</span>
          <span>
            <strong>ì‹œíŠ¸ëª… ê·œì¹™</strong> &mdash; ì„¹ì…˜ í—¤ë” í…ìŠ¤íŠ¸ê°€ ì‹œíŠ¸ëª…ì´ ë©ë‹ˆë‹¤.<br>
            ì—‘ì…€ ì‹œíŠ¸ëª… ì œí•œ(31ì)ì„ ì´ˆê³¼í•˜ë©´ ìë™ìœ¼ë¡œ ì˜ë¦½ë‹ˆë‹¤.<br>
            ë™ì¼ ì´ë¦„ì˜ ì„¹ì…˜ì´ ìˆìœ¼ë©´ ë’¤ì— <code>_2</code>, <code>_3</code> ì ‘ë¯¸ì‚¬ê°€ ë¶™ìŠµë‹ˆë‹¤.
          </span>
        </li>
      </ol>

      <div class="guide-tip">
        <strong>TIP</strong> &mdash;
        ê°ì§€ ê²°ê³¼ê°€ ì˜ˆìƒê³¼ ë‹¤ë¥´ë©´ <strong>[ë‹¤ì‹œ ê°ì§€]</strong> ë²„íŠ¼ì„ ëˆŒëŸ¬ íŒ¨í„´ì´ë‚˜ ì—´ì„ ë°”ê¿”ê°€ë©° ì¬ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        ì‚¬ìš©ì ì •ì˜ íŒ¨í„´ìœ¼ë¡œ ì›í•˜ëŠ” ì •ê·œì‹ì„ ì§ì ‘ ì…ë ¥í•˜ë©´ ì–´ë–¤ í˜•ì‹ì´ë“  ë¶„ë¦¬ ê°€ëŠ¥í•©ë‹ˆë‹¤.
      </div>

      <div class="guide-note">
        <strong>ì°¸ê³ </strong> &mdash;
        ì´ ë„êµ¬ëŠ” ë¸Œë¼ìš°ì €ì—ì„œ ë™ì‘í•˜ë©°, ì—…ë¡œë“œëœ íŒŒì¼ì€ ì„œë²„ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        ëª¨ë“  ì²˜ë¦¬ëŠ” ì‚¬ìš©ìì˜ PC ë‚´ì—ì„œë§Œ ì´ë£¨ì–´ì§‘ë‹ˆë‹¤. (ì˜¤í”„ë¼ì¸ì—ì„œë„ ì‚¬ìš© ê°€ëŠ¥ - ìµœì´ˆ 1íšŒ SheetJS ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© í•„ìš”)
      </span>
      </div>

    </div>
  </div>

  <!-- STEP 1: File Upload -->
  <div class="card">
    <h2><span class="step-badge">1</span> ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</h2>
    <div class="upload-area" id="uploadArea">
      <div class="upload-icon">ğŸ“‚</div>
      <p>í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ì—…ë¡œë“œ</p>
      <p style="font-size:12px; color:#aaa; margin-top:6px;">.xlsx, .xls íŒŒì¼ ì§€ì›</p>
      <div class="file-name" id="fileName"></div>
    </div>
    <input type="file" id="fileInput" accept=".xlsx,.xls">
  </div>

  <!-- STEP 2: Sheet Selection -->
  <div class="card hidden" id="step2">
    <h2><span class="step-badge">2</span> ë¶„ë¦¬í•  ì‹œíŠ¸ ì„ íƒ</h2>
    <div class="sheet-list" id="sheetList"></div>
  </div>

  <!-- STEP 3: Settings -->
  <div class="card hidden" id="step3">
    <h2><span class="step-badge">3</span> ë¶„ë¦¬ ì„¤ì •</h2>
    <div class="settings-row">
      <div class="setting-group">
        <label>ì„¹ì…˜ ê°ì§€ íŒ¨í„´</label>
        <select id="patternSelect">
          <option value="numDot">ìˆ«ì. í…ìŠ¤íŠ¸ (ì˜ˆ: 1. ê°œìš”)</option>
          <option value="numDotParen">ìˆ«ì) í…ìŠ¤íŠ¸ (ì˜ˆ: 1) ê°œìš”)</option>
          <option value="numParen">(ìˆ«ì) í…ìŠ¤íŠ¸ (ì˜ˆ: (1) ê°œìš”)</option>
          <option value="roman">ë¡œë§ˆìˆ«ì. í…ìŠ¤íŠ¸ (ì˜ˆ: I. ê°œìš”)</option>
          <option value="custom">ì‚¬ìš©ì ì •ì˜ (ì •ê·œì‹)</option>
        </select>
      </div>
      <div class="setting-group">
        <label>ê°ì§€ ì—´</label>
        <select id="columnSelect">
          <option value="A">Aì—´</option>
          <option value="B">Bì—´</option>
          <option value="C">Cì—´</option>
          <option value="D">Dì—´</option>
        </select>
      </div>
    </div>
    <div class="setting-group hidden" id="customPatternGroup" style="margin-top: 12px;">
      <label>ì‚¬ìš©ì ì •ì˜ ì •ê·œì‹</label>
      <input type="text" id="customPattern" placeholder="ì˜ˆ: ^\d+\.\s+.+">
      <p class="help-text">ìë°”ìŠ¤í¬ë¦½íŠ¸ ì •ê·œì‹ ë¬¸ë²•ì„ ì‚¬ìš©í•˜ì„¸ìš”</p>
    </div>
    <div class="checkbox-row">
      <input type="checkbox" id="includeHeader" checked>
      <label for="includeHeader">ê° ì‹œíŠ¸ì— ì„¹ì…˜ í—¤ë” í–‰ í¬í•¨</label>
    </div>
    <div class="actions">
      <button class="btn btn-primary" id="detectBtn" onclick="detectSections()">ì„¹ì…˜ ê°ì§€</button>
    </div>
  </div>

  <!-- STEP 4: Preview -->
  <div class="card hidden" id="step4">
    <h2><span class="step-badge">4</span> ê°ì§€ëœ ì„¹ì…˜ ë¯¸ë¦¬ë³´ê¸°</h2>
    <div class="summary-stats" id="summaryStats"></div>
    <div class="section-table-wrap">
      <table class="section-table">
        <thead>
          <tr>
            <th style="width:50px; text-align:center;">#</th>
            <th>ì‹œíŠ¸ëª… (ì„¹ì…˜ ì´ë¦„)</th>
            <th style="width:120px; text-align:center;">í–‰ ë²”ìœ„</th>
            <th style="width:80px; text-align:center;">í–‰ ìˆ˜</th>
          </tr>
        </thead>
        <tbody id="sectionBody"></tbody>
      </table>
    </div>
    <div class="actions">
      <button class="btn btn-success" id="downloadBtn" onclick="splitAndDownload()">ë¶„ë¦¬ & ë‹¤ìš´ë¡œë“œ</button>
      <button class="btn btn-outline" onclick="detectSections()">ë‹¤ì‹œ ê°ì§€</button>
    </div>
    <div class="progress-bar" id="progressBar"><div class="fill" id="progressFill"></div></div>
    <div class="status-text" id="statusText"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€ State â”€â”€
let workbook = null;
let originalFileName = '';
let selectedSheet = '';
let detectedSections = [];

// â”€â”€ Pattern Presets â”€â”€
const PATTERNS = {
  numDot:     /^\s*(\d+)\.\s+(.+)/,
  numDotParen:/^\s*(\d+)\)\s+(.+)/,
  numParen:   /^\s*\((\d+)\)\s+(.+)/,
  roman:      /^\s*([IVXLCDM]+)\.\s+(.+)/i,
};

// â”€â”€ File Upload â”€â”€
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');

uploadArea.addEventListener('click', () => fileInput.click());

uploadArea.addEventListener('dragover', e => {
  e.preventDefault();
  uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
  uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', e => {
  e.preventDefault();
  uploadArea.classList.remove('dragover');
  if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
});

fileInput.addEventListener('change', e => {
  if (e.target.files.length) handleFile(e.target.files[0]);
});

function handleFile(file) {
  if (!file.name.match(/\.xlsx?$/i)) {
    showToast('ì—‘ì…€ íŒŒì¼(.xlsx, .xls)ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤');
    return;
  }

  originalFileName = file.name.replace(/\.[^.]+$/, '');
  document.getElementById('fileName').textContent = file.name;
  uploadArea.classList.add('has-file');

  const reader = new FileReader();
  reader.onload = e => {
    try {
      workbook = XLSX.read(e.target.result, { type: 'array' });
      showSheets();
      showToast(`"${file.name}" ë¡œë“œ ì™„ë£Œ (${workbook.SheetNames.length}ê°œ ì‹œíŠ¸)`);
    } catch (err) {
      showToast('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: ' + err.message);
    }
  };
  reader.readAsArrayBuffer(file);
}

// â”€â”€ Sheet Selection â”€â”€
function showSheets() {
  const list = document.getElementById('sheetList');
  list.innerHTML = '';

  workbook.SheetNames.forEach(name => {
    const btn = document.createElement('button');
    btn.className = 'sheet-btn';
    btn.textContent = name;
    btn.onclick = () => selectSheet(name, btn);
    list.appendChild(btn);
  });

  show('step2');
  hide('step3');
  hide('step4');
}

function selectSheet(name, btnEl) {
  selectedSheet = name;
  document.querySelectorAll('.sheet-btn').forEach(b => b.classList.remove('selected'));
  btnEl.classList.add('selected');
  show('step3');
  hide('step4');
}

// â”€â”€ Pattern Select â”€â”€
document.getElementById('patternSelect').addEventListener('change', e => {
  if (e.target.value === 'custom') {
    show('customPatternGroup');
  } else {
    hide('customPatternGroup');
  }
});

// â”€â”€ Section Detection â”€â”€
function getPattern() {
  const sel = document.getElementById('patternSelect').value;
  if (sel === 'custom') {
    const raw = document.getElementById('customPattern').value.trim();
    if (!raw) { showToast('ì •ê·œì‹ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return null; }
    try { return new RegExp(raw); } catch(e) { showToast('ì˜ëª»ëœ ì •ê·œì‹: ' + e.message); return null; }
  }
  return PATTERNS[sel];
}

function getColumnIndex() {
  const col = document.getElementById('columnSelect').value;
  return col.charCodeAt(0) - 65; // A=0, B=1, ...
}

function detectSections() {
  if (!workbook || !selectedSheet) {
    showToast('ì‹œíŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”');
    return;
  }

  const pattern = getPattern();
  if (!pattern) return;

  const colIdx = getColumnIndex();
  const ws = workbook.Sheets[selectedSheet];
  const data = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });

  detectedSections = [];

  data.forEach((row, i) => {
    const cellVal = String(row[colIdx] || '').trim();
    if (cellVal && pattern.test(cellVal)) {
      detectedSections.push({
        row: i,           // 0-based index in data array
        rowDisplay: i + 1, // 1-based row number
        name: cellVal,
      });
    }
  });

  // Calculate row ranges
  detectedSections.forEach((sec, idx) => {
    const nextRow = idx < detectedSections.length - 1
      ? detectedSections[idx + 1].row
      : data.length;
    sec.endRow = nextRow - 1;
    sec.rowCount = nextRow - sec.row;
  });

  if (detectedSections.length === 0) {
    showToast('ê°ì§€ëœ ì„¹ì…˜ì´ ì—†ìŠµë‹ˆë‹¤. íŒ¨í„´ì´ë‚˜ ì—´ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
    return;
  }

  renderPreview(data.length);
  show('step4');
  showToast(`${detectedSections.length}ê°œ ì„¹ì…˜ ê°ì§€ë¨`);
}

function renderPreview(totalRows) {
  // Summary stats
  const stats = document.getElementById('summaryStats');
  const totalSectionRows = detectedSections.reduce((s, sec) => s + sec.rowCount, 0);
  stats.innerHTML = `
    <div class="stat-box">
      <div class="value">${detectedSections.length}</div>
      <div class="label">ê°ì§€ëœ ì„¹ì…˜</div>
    </div>
    <div class="stat-box">
      <div class="value">${totalRows.toLocaleString()}</div>
      <div class="label">ì „ì²´ í–‰ ìˆ˜</div>
    </div>
    <div class="stat-box">
      <div class="value">${totalSectionRows.toLocaleString()}</div>
      <div class="label">ë¶„ë¦¬ ëŒ€ìƒ í–‰</div>
    </div>
  `;

  // Table
  const tbody = document.getElementById('sectionBody');
  tbody.innerHTML = detectedSections.map((sec, i) => `
    <tr>
      <td class="num">${i + 1}</td>
      <td>${escHtml(sec.name)}</td>
      <td class="range">${sec.rowDisplay} ~ ${sec.endRow + 1}</td>
      <td class="rows">${sec.rowCount}</td>
    </tr>
  `).join('');
}

// â”€â”€ Split & Download â”€â”€
function splitAndDownload() {
  if (!detectedSections.length) return;

  const btn = document.getElementById('downloadBtn');
  btn.disabled = true;
  btn.textContent = 'ì²˜ë¦¬ ì¤‘...';

  const progressBar = document.getElementById('progressBar');
  const progressFill = document.getElementById('progressFill');
  const statusText = document.getElementById('statusText');
  progressBar.style.display = 'block';
  statusText.style.display = 'block';

  // Use setTimeout to allow UI to update
  setTimeout(() => {
    try {
      const ws = workbook.Sheets[selectedSheet];
      const data = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
      const includeHeader = document.getElementById('includeHeader').checked;

      // Gather merge info from original sheet
      const merges = ws['!merges'] || [];
      const colWidths = ws['!cols'] || [];
      const rowHeights = ws['!rows'] || [];

      const newWb = XLSX.utils.book_new();
      const usedNames = {};

      detectedSections.forEach((sec, idx) => {
        const pct = Math.round(((idx + 1) / detectedSections.length) * 100);
        progressFill.style.width = pct + '%';
        statusText.textContent = `ì²˜ë¦¬ ì¤‘: ${sec.name} (${idx + 1}/${detectedSections.length})`;

        // Determine data range
        const startRow = sec.row;
        const endRow = idx < detectedSections.length - 1
          ? detectedSections[idx + 1].row
          : data.length;

        const sectionData = data.slice(startRow, endRow);

        // Create sheet name (max 31 chars, no invalid chars)
        let sheetName = sec.name
          .replace(/[\\\/\?\*\[\]:]/g, '')
          .substring(0, 31);

        if (!sheetName) sheetName = `Section_${idx + 1}`;

        // Handle duplicates
        if (usedNames[sheetName]) {
          usedNames[sheetName]++;
          const suffix = `_${usedNames[sheetName]}`;
          sheetName = sheetName.substring(0, 31 - suffix.length) + suffix;
        } else {
          usedNames[sheetName] = 1;
        }

        const newWs = XLSX.utils.aoa_to_sheet(sectionData);

        // Copy column widths
        if (colWidths.length) {
          newWs['!cols'] = JSON.parse(JSON.stringify(colWidths));
        }

        // Remap merges that fall within this section
        const sectionMerges = [];
        merges.forEach(m => {
          if (m.s.r >= startRow && m.e.r < endRow) {
            sectionMerges.push({
              s: { r: m.s.r - startRow, c: m.s.c },
              e: { r: m.e.r - startRow, c: m.e.c },
            });
          }
        });
        if (sectionMerges.length) {
          newWs['!merges'] = sectionMerges;
        }

        // Copy cell styles from original sheet
        for (let r = startRow; r < endRow; r++) {
          const row = data[r];
          if (!row) continue;
          for (let c = 0; c < row.length; c++) {
            const origAddr = XLSX.utils.encode_cell({ r: r, c: c });
            const newAddr = XLSX.utils.encode_cell({ r: r - startRow, c: c });
            const origCell = ws[origAddr];
            const newCell = newWs[newAddr];
            if (origCell && newCell && origCell.s) {
              newCell.s = JSON.parse(JSON.stringify(origCell.s));
            }
          }
        }

        XLSX.utils.book_append_sheet(newWb, newWs, sheetName);
      });

      // Generate filename
      const outName = `${originalFileName}_${selectedSheet}_ë¶„ë¦¬.xlsx`;

      // Download
      XLSX.writeFile(newWb, outName);

      statusText.textContent = `ì™„ë£Œ! "${outName}" ë‹¤ìš´ë¡œë“œë¨ (${detectedSections.length}ê°œ ì‹œíŠ¸)`;
      showToast('ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!');
    } catch (err) {
      statusText.textContent = 'ì˜¤ë¥˜ ë°œìƒ: ' + err.message;
      showToast('ì˜¤ë¥˜: ' + err.message);
      console.error(err);
    } finally {
      btn.disabled = false;
      btn.textContent = 'ë¶„ë¦¬ & ë‹¤ìš´ë¡œë“œ';
    }
  }, 100);
}

// â”€â”€ Guide Toggle â”€â”€
function toggleGuide() {
  const body = document.getElementById('guideBody');
  const arrow = document.getElementById('guideArrow');
  body.classList.toggle('open');
  arrow.classList.toggle('open');
}

// â”€â”€ Utilities â”€â”€
function show(id) { document.getElementById(id).classList.remove('hidden'); }
function hide(id) { document.getElementById(id).classList.add('hidden'); }
function escHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}
</script>

</body>
</html>
